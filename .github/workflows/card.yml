name: Guild Kai - RPG Card

on:
  schedule:
    - cron: '0 0 * * 0'  # Executa todo domingo Ã  meia-noite
  workflow_dispatch:      # Permite execuÃ§Ã£o manual
  push:
    branches: [ main, master ]
    paths:
      - '.github/workflows/guild-kai.yml'

permissions:
  contents: write

jobs:
  generate-rpg-card:
    runs-on: ubuntu-latest
    name: ğŸ›¡ï¸ Generate RPG Card
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup environment
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Generate RPG Card SVG
        env:
          GITHUB_USERNAME: "ciconha"
          USER_CLASS: "ğŸš€ Lenda Fullstack"
          USER_AREA: "fullstack"
          USER_COMPANY: "INSS"
        run: |
          echo "ğŸ® Iniciando geraÃ§Ã£o do Guild Card para: $GITHUB_USERNAME"
          
          # Criar diretÃ³rio para os cartÃµes
          mkdir -p guild-cards
          
          # Buscar dados do GitHub
          echo "ğŸ“¡ Buscando dados do GitHub..."
          USER_RESPONSE=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/users/$GITHUB_USERNAME")
          
          # Extrair dados do usuÃ¡rio
          AVATAR_URL=$(echo "$USER_RESPONSE" | jq -r '.avatar_url // empty')
          PUBLIC_REPOS=$(echo "$USER_RESPONSE" | jq -r '.public_repos // 0')
          FOLLOWERS=$(echo "$USER_RESPONSE" | jq -r '.followers // 0')
          FOLLOWING=$(echo "$USER_RESPONSE" | jq -r '.following // 0')
          CREATED_AT=$(echo "$USER_RESPONSE" | jq -r '.created_at // empty')
          
          # Buscar repositÃ³rios
          echo "ğŸ“š Buscando repositÃ³rios..."
          REPOS_RESPONSE=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/users/$GITHUB_USERNAME/repos?sort=updated&per_page=100")
          
          # Calcular total de stars
          TOTAL_STARS=$(echo "$REPOS_RESPONSE" | jq '[.[].stargazers_count] | add // 0')
          
          # Calcular XP baseado em vÃ¡rias mÃ©tricas
          XP_REPOS=$((PUBLIC_REPOS * 50))
          XP_FOLLOWERS=$((FOLLOWERS * 30))
          XP_STARS=$((TOTAL_STARS * 5))
          TOTAL_XP=$((XP_REPOS + XP_FOLLOWERS + XP_STARS))
          
          # Calcular nÃ­vel
          LEVEL=1
          XP_NEXT=100
          if [ $TOTAL_XP -lt 1000 ]; then
            LEVEL=$((TOTAL_XP / 100 + 1))
            XP_NEXT=$((100 - (TOTAL_XP % 100)))
          elif [ $TOTAL_XP -lt 5000 ]; then
            LEVEL=$((10 + (TOTAL_XP - 1000) / 250))
            XP_NEXT=$((250 - ((TOTAL_XP - 1000) % 250)))
          else
            LEVEL=$((26 + (TOTAL_XP - 5000) / 500))
            XP_NEXT=$((500 - ((TOTAL_XP - 5000) % 500)))
          fi
          
          # Determinar rank baseado no nÃ­vel
          if [ $LEVEL -lt 5 ]; then
            RANK="ğŸ¥‰ Novato"
          elif [ $LEVEL -lt 15 ]; then
            RANK="ğŸ¥ˆ Aventureiro"
          elif [ $LEVEL -lt 25 ]; then
            RANK="ğŸ¥‡ HerÃ³i"
          elif [ $LEVEL -lt 35 ]; then
            RANK="ğŸ’ Mestre"
          else
            RANK="ğŸ”¥ LendÃ¡rio"
          fi
          
          # Calcular idade da conta em anos
          if [ -n "$CREATED_AT" ]; then
            ACCOUNT_CREATED=$(date -d "$CREATED_AT" +%s)
            NOW=$(date +%s)
            ACCOUNT_AGE_YEARS=$(( (NOW - ACCOUNT_CREATED) / 31536000 ))
          else
            ACCOUNT_AGE_YEARS=1
          fi
          
          # Buscar top 3 projetos com mais stars
          TOP_PROJECTS=$(echo "$REPOS_RESPONSE" | jq -r '
            [.[] | select(.fork == false)] | 
            sort_by(-(.stargazers_count // 0)) | 
            .[0:3] | 
            .[] | 
            "\(.name)|\(.description // "Sem descriÃ§Ã£o")|\(.stargazers_count // 0)|\(.language // "Unknown")"')
          
          # Extrair projetos individuais
          if [ -n "$TOP_PROJECTS" ]; then
            PROJECT_1=$(echo "$TOP_PROJECTS" | sed -n '1p')
            PROJECT_2=$(echo "$TOP_PROJECTS" | sed -n '2p')
            PROJECT_3=$(echo "$TOP_PROJECTS" | sed -n '3p')
          else
            PROJECT_1="Nenhum projeto|Sem descriÃ§Ã£o|0"
            PROJECT_2="Nenhum projeto|Sem descriÃ§Ã£o|0"
            PROJECT_3="Nenhum projeto|Sem descriÃ§Ã£o|0"
          fi
          
          # Extrair dados dos projetos
          PROJ1_NAME=$(echo "$PROJECT_1" | cut -d'|' -f1)
          PROJ1_DESC=$(echo "$PROJECT_1" | cut -d'|' -f2)
          PROJ1_STARS=$(echo "$PROJECT_1" | cut -d'|' -f3)
          
          PROJ2_NAME=$(echo "$PROJECT_2" | cut -d'|' -f1)
          PROJ2_DESC=$(echo "$PROJECT_2" | cut -d'|' -f2)
          PROJ2_STARS=$(echo "$PROJECT_2" | cut -d'|' -f3)
          
          PROJ3_NAME=$(echo "$PROJECT_3" | cut -d'|' -f1)
          PROJ3_DESC=$(echo "$PROJECT_3" | cut -d'|' -f2)
          PROJ3_STARS=$(echo "$PROJECT_3" | cut -d'|' -f3)
          
          # Limitar comprimento das descriÃ§Ãµes
          PROJ1_DESC="${PROJ1_DESC:0:30}"
          PROJ2_DESC="${PROJ2_DESC:0:30}"
          PROJ3_DESC="${PROJ3_DESC:0:30}"
          
          # Calcular porcentagem XP
          if [ $TOTAL_XP -lt 1000 ]; then
            XP_PERCENT=$(( (TOTAL_XP % 100) * 100 / 100 ))
          elif [ $TOTAL_XP -lt 5000 ]; then
            XP_PERCENT=$(( ((TOTAL_XP - 1000) % 250) * 100 / 250 ))
          else
            XP_PERCENT=$(( ((TOTAL_XP - 5000) % 500) * 100 / 500 ))
          fi
          
          # Garantir que XP_PERCENT nÃ£o seja negativo
          if [ $XP_PERCENT -lt 0 ]; then
            XP_PERCENT=0
          fi
          
          XP_BAR_WIDTH=$((260 * XP_PERCENT / 100))
          
          echo "ğŸ¨ Gerando cartÃ£o SVG..."
          
          # Data atual
          CURRENT_DATE=$(date +'%d/%m/%Y')
          
          # Gerar SVG completo usando variÃ¡veis
          cat > "guild-cards/${GITHUB_USERNAME}.svg" << EOF
<svg xmlns="http://www.w3.org/2000/svg" width="400" height="500" viewBox="0 0 400 500">
  <defs>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Segoe+UI:wght@300;400;600;700&display=swap');
      .title { font: bold 24px 'Segoe UI', sans-serif; fill: #f8f9fa; }
      .subtitle { font: 600 16px 'Segoe UI', sans-serif; fill: #adb5bd; }
      .text { font: 14px 'Segoe UI', sans-serif; fill: #dee2e6; }
      .stat { font: 12px 'Segoe UI', sans-serif; fill: #6c757d; }
      .highlight { fill: #20c997; }
      .warning { fill: #ffc107; }
      .danger { fill: #dc3545; }
    </style>
    <linearGradient id="bgGradient" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" stop-color="#1a1a2e"/>
      <stop offset="50%" stop-color="#16213e"/>
      <stop offset="100%" stop-color="#0f3460"/>
    </linearGradient>
    <linearGradient id="xpGradient" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" stop-color="#20c997"/>
      <stop offset="100%" stop-color="#0dcaf0"/>
    </linearGradient>
    <clipPath id="avatarClip">
      <circle cx="60" cy="60" r="45"/>
    </clipPath>
  </defs>
  
  <!-- Background -->
  <rect width="100%" height="100%" fill="url(#bgGradient)" rx="15"/>
  
  <!-- Header -->
  <rect width="100%" height="80" fill="rgba(0,0,0,0.3)" rx="15 15 0 0"/>
  <text x="50%" y="45" text-anchor="middle" class="title">ğŸ›¡ï¸ Guild Kai RPG</text>
  <text x="50%" y="70" text-anchor="middle" class="subtitle">$USER_CLASS</text>
  
  <!-- Avatar -->
  <g clip-path="url(#avatarClip)">
    <image href="https://github.com/$GITHUB_USERNAME.png" x="15" y="15" width="90" height="90"/>
  </g>
  <circle cx="60" cy="60" r="47" fill="none" stroke="#20c997" stroke-width="2"/>
  
  <!-- User Info -->
  <text x="120" y="40" class="title">@$GITHUB_USERNAME</text>
  <text x="120" y="65" class="subtitle">NÃ­vel $LEVEL â€¢ $RANK</text>
  
  <!-- XP Bar -->
  <rect x="120" y="75" width="260" height="8" fill="#495057" rx="4"/>
  <rect x="120" y="75" width="$XP_BAR_WIDTH" height="8" fill="url(#xpGradient)" rx="4"/>
  <text x="120" y="95" class="stat">âš¡ $TOTAL_XP XP â€¢ $XP_PERCENT% para o prÃ³ximo nÃ­vel</text>
  
  <!-- Stats Grid -->
  <g transform="translate(30, 120)">
    <rect x="0" y="0" width="170" height="80" fill="rgba(255,255,255,0.05)" rx="8"/>
    <text x="85" y="25" text-anchor="middle" class="subtitle">ğŸ“Š EstatÃ­sticas</text>
    <text x="20" y="50" class="stat">ğŸ“š $PUBLIC_REPOS Repos</text>
    <text x="20" y="70" class="stat">â­ $TOTAL_STARS Stars</text>
    <text x="100" y="50" class="stat">ğŸ‘¥ $FOLLOWERS Seguidores</text>
    <text x="100" y="70" class="stat">ğŸ• $ACCOUNT_AGE_YEARS ano(s)</text>
  </g>
  
  <g transform="translate(220, 120)">
    <rect x="0" y="0" width="170" height="80" fill="rgba(255,255,255,0.05)" rx="8"/>
    <text x="85" y="25" text-anchor="middle" class="subtitle">ğŸ¢ Profissional</text>
    <text x="85" y="50" text-anchor="middle" class="text">$USER_COMPANY</text>
    <text x="85" y="70" text-anchor="middle" class="stat">$USER_AREA</text>
  </g>
  
  <!-- Top Projects -->
  <text x="30" y="230" class="subtitle">â­ Projetos Destacados:</text>
  <g transform="translate(30, 245)">
    <text x="0" y="0" class="text">â€¢ $PROJ1_NAME â­$PROJ1_STARS</text>
    <text x="0" y="20" class="stat">  $PROJ1_DESC</text>
    
    <text x="0" y="50" class="text">â€¢ $PROJ2_NAME â­$PROJ2_STARS</text>
    <text x="0" y="70" class="stat">  $PROJ2_DESC</text>
    
    <text x="0" y="100" class="text">â€¢ $PROJ3_NAME â­$PROJ3_STARS</text>
    <text x="0" y="120" class="stat">  $PROJ3_DESC</text>
  </g>
  
  <!-- Footer -->
  <rect width="100%" height="30" y="470" fill="rgba(0,0,0,0.4)" rx="0 0 15 15"/>
  <text x="50%" y="490" text-anchor="middle" class="stat">
    ğŸ›¡ï¸ Guild Kai â€¢ Gerado em $CURRENT_DATE â€¢ github.com/$GITHUB_USERNAME
  </text>
</svg>
EOF
          
          echo "âœ… CartÃ£o SVG gerado com sucesso!"
          echo "ğŸ“ Salvo em: guild-cards/$GITHUB_USERNAME.svg"

      - name: Commit and Push Changes
        run: |
          echo "ğŸ“¦ Verificando mudanÃ§as..."
          git status
          
          if [ -n "$(git status --porcelain)" ]; then
            echo "ğŸš€ Commitando mudanÃ§as..."
            git add guild-cards/
            git commit -m "ğŸ® Atualizar Guild Card - $(date +'%d/%m/%Y %H:%M')"
            git push
            echo "âœ… MudanÃ§as commitadas e enviadas!"
          else
            echo "ğŸ“ Nenhuma mudanÃ§a para commitar"
          fi

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: guild-kai-card
          path: guild-cards/
          retention-days: 7

      - name: Success Notification
        if: success()
        run: |
          echo "ğŸ‰ Guild Kai Card gerado com sucesso!"
          echo "ğŸ‘¤ UsuÃ¡rio: ciconha"
          echo "ğŸ›¡ï¸ Classe: $USER_CLASS"
          echo "ğŸ¢ Empresa: $USER_COMPANY"
          echo "ğŸ’¼ Ãrea: $USER_AREA"
