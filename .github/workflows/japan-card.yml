name: ğŸˆ¶ Create japan-card

on:
  workflow_dispatch:
    inputs:
      usuario:
        description: "UsuÃ¡rio do GitHub (ex: ciconha)"
        required: true
        default: "ciconha"

permissions:
  contents: write

jobs:
  gerar-card-japones:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Preparar ambiente
        run: |
          set -e
          sudo apt-get update -y
          sudo apt-get install -y curl jq librsvg2-bin

      - name: Buscar dados do GitHub
        id: dados
        run: |
          set -e
          USER="${{ github.event.inputs.usuario }}"
          echo "Coletando dados para: $USER"

          curl -s "https://api.github.com/users/${USER}" -o user.json
          curl -s "https://api.github.com/users/${USER}/repos?per_page=100" -o repos.json
          curl -s "https://api.github.com/users/${USER}/events?per_page=100" -o events.json

          sanitize() {
            # remove quebras e escape de aspas
            echo "$1" | tr -d '\n' | sed 's/"/\\"/g'
          }

          LOGIN=$(jq -r '.login // ""' user.json)
          AVATAR=$(jq -r '.avatar_url // ""' user.json)
          REPOS=$(jq -r '.public_repos // 0' user.json)
          FOLLOWERS=$(jq -r '.followers // 0' user.json)
          COMMITS=$(jq '[.[] | select(.type == "PushEvent")] | length' events.json)
          PRS=$(jq '[.[] | select(.type == "PullRequestEvent")] | length' events.json)
          ISSUES=$(jq '[.[] | select(.type == "IssuesEvent")] | length' events.json)
          XP=$((REPOS * 50 + FOLLOWERS * 20 + COMMITS * 2 + PRS * 10 + ISSUES * 5))
          LEVEL=$((XP / 1000 + 1))
          DATE=$(date +'%Yå¹´%mæœˆ%dæ—¥')

          # top repo safe
          TOP1=$(jq -r 'sort_by(-.stargazers_count) | .[0].name // "ãªã—"' repos.json)
          TOP1_DESC=$(jq -r 'sort_by(-.stargazers_count) | .[0].description // "èª¬æ˜ãªã—"' repos.json)
          TOP1_DESC=$(sanitize "$TOP1_DESC")

          # export outputs
          echo "login=${LOGIN}" >> "$GITHUB_OUTPUT"
          echo "avatar=${AVATAR}" >> "$GITHUB_OUTPUT"
          echo "repos=${REPOS}" >> "$GITHUB_OUTPUT"
          echo "followers=${FOLLOWERS}" >> "$GITHUB_OUTPUT"
          echo "commits=${COMMITS}" >> "$GITHUB_OUTPUT"
          echo "prs=${PRS}" >> "$GITHUB_OUTPUT"
          echo "issues=${ISSUES}" >> "$GITHUB_OUTPUT"
          echo "xp=${XP}" >> "$GITHUB_OUTPUT"
          echo "level=${LEVEL}" >> "$GITHUB_OUTPUT"
          echo "date=${DATE}" >> "$GITHUB_OUTPUT"
          echo "top1=${TOP1}" >> "$GITHUB_OUTPUT"
          echo "top1_desc=${TOP1_DESC}" >> "$GITHUB_OUTPUT"

      - name: Gerar SVG (Japan Cyberpunk, preto/branco/vermelho)
        run: |
          set -e
          USER="${{ github.event.inputs.usuario }}"
          mkdir -p japan

          LOGIN="${{ steps.dados.outputs.login }}"
          AVATAR="${{ steps.dados.outputs.avatar }}"
          REPOS="${{ steps.dados.outputs.repos }}"
          FOLLOWERS="${{ steps.dados.outputs.followers }}"
          COMMITS="${{ steps.dados.outputs.commits }}"
          PRS="${{ steps.dados.outputs.prs }}"
          ISSUES="${{ steps.dados.outputs.issues }}"
          XP="${{ steps.dados.outputs.xp }}"
          LEVEL="${{ steps.dados.outputs.level }}"
          DATE="${{ steps.dados.outputs.date }}"
          TOP1="${{ steps.dados.outputs.top1 }}"
          TOP1_DESC="${{ steps.dados.outputs.top1_desc }}"

          # calcula barra (segura)
          BAR_TOTAL=360
          FILLED=$(( (XP % 1000) * BAR_TOTAL / 1000 ))

          # Cria SVG com layout minimal cyberpunk japonÃªs (preto, branco, vermelho)
          cat > "japan/${USER}-card.svg" <<'SVG'
<svg xmlns="http://www.w3.org/2000/svg" width="920" height="560" viewBox="0 0 920 560">
  <style>
    .bg{fill:#000}
    .moon{fill:#b70a0a}
    .title{font: bold 36px "Noto Sans JP", sans-serif; fill:#fff}
    .sub{font:18px "Noto Sans JP", sans-serif; fill:#ddd}
    .mono{font:16px "Courier New", monospace; fill:#fff}
    .small{font:14px "Noto Sans JP", sans-serif; fill:#bbb}
    .bar-bg{fill:#111}
    .bar-fill{fill:#b70a0a}
  </style>
  <rect width="100%" height="100%" class="bg" rx="28"/>

  <!-- Red moon / japanese sun -->
  <g transform="translate(720,120)">
    <circle cx="0" cy="0" r="120" class="moon"/>
    <g transform="translate(-20,-30)" fill="#fff" font-family="Noto Sans JP">
      <text x="0" y="0" font-size="34" font-weight="700" text-anchor="middle">å…ˆé§†è€…</text>
      <text x="0" y="40" font-size="18" text-anchor="middle">è·æ¥­: ã‚³ãƒ¼ãƒ‰ã®å†’é™ºè€…</text>
    </g>
  </g>

  <!-- Avatar (fundo branco pequeno) -->
  <defs>
    <clipPath id="avatarClip"><circle cx="120" cy="120" r="80"/></clipPath>
  </defs>
  <rect x="30" y="60" width="180" height="180" rx="18" fill="#111" />
  <image href="${AVATAR_PLACEHOLDER}" x="40" y="70" width="160" height="160" clip-path="url(#avatarClip)"/>

  <!-- Left texts (japanese) -->
  <text x="240" y="110" class="title">ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼š${LOGIN_PLACEHOLDER}</text>
  <text x="240" y="150" class="sub">ç‹¬ç«‹ â€¢ å€‹äººé–‹ç™ºè€…</text>
  <text x="240" y="185" class="small">ãƒªãƒã‚¸ãƒˆãƒªï¼š${REPOS_PLACEHOLDER}</text>
  <text x="240" y="210" class="small">ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ï¼š${FOLLOWERS_PLACEHOLDER}</text>

  <!-- activity -->
  <text x="240" y="250" class="small">ã‚³ãƒŸãƒƒãƒˆ / PR / èª²é¡Œï¼š${COMMITS_PLACEHOLDER} / ${PRS_PLACEHOLDER} / ${ISSUES_PLACEHOLDER}</text>

  <!-- top repo -->
  <text x="240" y="290" class="small">ãƒˆãƒƒãƒ—: ${TOP1_PLACEHOLDER} â€” ${TOP1_DESC_PLACEHOLDER}</text>

  <!-- XP bar -->
  <rect x="60" y="340" width="360" height="18" rx="9" class="bar-bg"/>
  <rect x="60" y="340" width="${FILLED_PLACEHOLDER}" height="18" rx="9" class="bar-fill"/>
  <text x="240" y="380" class="mono" text-anchor="middle">LV.${LEVEL_PLACEHOLDER} â€¢ çµŒé¨“å€¤ ${XP_PLACEHOLDER}</text>

  <text x="760" y="520" class="small" text-anchor="end">${DATE_PLACEHOLDER}</text>
</svg>
SVG

          # SubstituiÃ§Ãµes seguras (uso sed, escape de /)
          svgfile="japan/${USER}-card.svg"
          sed -i "s|${AVATAR_PLACEHOLDER}|${AVATAR}|g" "$svgfile"
          sed -i "s|${LOGIN_PLACEHOLDER}|${LOGIN}|g" "$svgfile"
          sed -i "s|${REPOS_PLACEHOLDER}|${REPOS}|g" "$svgfile"
          sed -i "s|${FOLLOWERS_PLACEHOLDER}|${FOLLOWERS}|g" "$svgfile"
          sed -i "s|${COMMITS_PLACEHOLDER}|${COMMITS}|g" "$svgfile"
          sed -i "s|${PRS_PLACEHOLDER}|${PRS}|g" "$svgfile"
          sed -i "s|${ISSUES_PLACEHOLDER}|${ISSUES}|g" "$svgfile"
          sed -i "s|${XP_PLACEHOLDER}|${XP}|g" "$svgfile"
          sed -i "s|${LEVEL_PLACEHOLDER}|${LEVEL}|g" "$svgfile"
          sed -i "s|${DATE_PLACEHOLDER}|${DATE}|g" "$svgfile"
          sed -i "s|${TOP1_PLACEHOLDER}|${TOP1}|g" "$svgfile"
          sed -i "s|${TOP1_DESC_PLACEHOLDER}|${TOP1_DESC}|g" "$svgfile"
          sed -i "s|${FILLED_PLACEHOLDER}|${FILLED}|g" "$svgfile"

          echo "SVG criado: $svgfile"

      - name: Converter SVG para PNG (920x560)
        run: |
          set -e
          svg="japan/${{ github.event.inputs.usuario }}-card.svg"
          png="japan/${{ github.event.inputs.usuario }}-card.png"
          if [ -f "$svg" ]; then
            rsvg-convert -w 920 -h 560 "$svg" -o "$png"
            echo "PNG gerado: $png"
          else
            echo "SVG nÃ£o encontrado: $svg" >&2
            exit 1
          fi

      - name: Commit e Push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add japan/
          git commit -m "ğŸˆ¶ Gerado japan card para ${{ github.event.inputs.usuario }}" || echo "Sem mudanÃ§as para commitar"
          git push
