name: ğŸˆ¶ JAPAN CYBER CARD

on:
  workflow_dispatch:
    inputs:
      usuario:
        description: "UsuÃ¡rio do GitHub (ex: ciconha)"
        required: true
        default: "ciconha"

permissions:
  contents: write

jobs:
  gerar-card-japones:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§© Checkout do repositÃ³rio
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: âš™ï¸ Instalar dependÃªncias
        run: |
          sudo apt-get update -y
          sudo apt-get install -y curl jq librsvg2-bin

      - name: ğŸ” Buscar dados do GitHub
        id: dados
        run: |
          USER="${{ github.event.inputs.usuario }}"
          curl -s "https://api.github.com/users/$USER" > user.json
          curl -s "https://api.github.com/users/$USER/repos?per_page=100" > repos.json
          curl -s "https://api.github.com/users/$USER/events?per_page=100" > events.json

          LOGIN=$(jq -r '.login' user.json)
          AVATAR=$(jq -r '.avatar_url' user.json)
          REPOS=$(jq -r '.public_repos' user.json)
          FOLLOWERS=$(jq -r '.followers' user.json)
          COMMITS=$(jq '[.[] | select(.type == "PushEvent")] | length' events.json)
          PRS=$(jq '[.[] | select(.type == "PullRequestEvent")] | length' events.json)
          ISSUES=$(jq '[.[] | select(.type == "IssuesEvent")] | length' events.json)
          XP=$((REPOS * 50 + FOLLOWERS * 20 + COMMITS * 2 + PRS * 10 + ISSUES * 5))
          LEVEL=$((XP / 1000 + 1))
          DATE=$(date +'%Yå¹´%mæœˆ%dæ—¥')

          mkdir -p japan

          echo "LOGIN=$LOGIN" >> $GITHUB_OUTPUT
          echo "AVATAR=$AVATAR" >> $GITHUB_OUTPUT
          echo "REPOS=$REPOS" >> $GITHUB_OUTPUT
          echo "FOLLOWERS=$FOLLOWERS" >> $GITHUB_OUTPUT
          echo "COMMITS=$COMMITS" >> $GITHUB_OUTPUT
          echo "PRS=$PRS" >> $GITHUB_OUTPUT
          echo "ISSUES=$ISSUES" >> $GITHUB_OUTPUT
          echo "XP=$XP" >> $GITHUB_OUTPUT
          echo "LEVEL=$LEVEL" >> $GITHUB_OUTPUT
          echo "DATE=$DATE" >> $GITHUB_OUTPUT

      - name: ğŸ¨ Gerar SVG estilo JapÃ£o Cyberpunk
        run: |
          LOGIN="${{ steps.dados.outputs.LOGIN }}"
          AVATAR="${{ steps.dados.outputs.AVATAR }}"
          REPOS="${{ steps.dados.outputs.REPOS }}"
          FOLLOWERS="${{ steps.dados.outputs.FOLLOWERS }}"
          COMMITS="${{ steps.dados.outputs.COMMITS }}"
          PRS="${{ steps.dados.outputs.PRS }}"
          ISSUES="${{ steps.dados.outputs.ISSUES }}"
          XP="${{ steps.dados.outputs.XP }}"
          LEVEL="${{ steps.dados.outputs.LEVEL }}"
          DATE="${{ steps.dados.outputs.DATE }}"

          cat > japan/card.svg <<EOF
<svg xmlns="http://www.w3.org/2000/svg" width="460" height="280">
  <style>
    .bg { fill: #000; }
    .moon { fill: #ff0000; }
    .text { font: bold 14px 'Noto Sans JP', sans-serif; fill: #fff; }
    .label { font: 12px 'Noto Sans JP', sans-serif; fill: #ccc; }
    .bar { fill: #ff0000; }
  </style>
  <rect width="100%" height="100%" class="bg"/>
  <circle cx="400" cy="60" r="40" class="moon"/>
  <image href="${AVATAR}" x="30" y="30" width="60" height="60" clip-path="url(#clip)"/>
  <defs><clipPath id="clip"><circle cx="60" cy="60" r="30"/></clipPath></defs>

  <text x="110" y="50" class="text">ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼š${LOGIN}</text>
  <text x="110" y="75" class="label">è·æ¥­ï¼šã‚³ãƒ¼ãƒ‰ã®å†’é™ºè€…</text>
  <text x="110" y="95" class="label">ç‹¬ç«‹ â€¢ å€‹äººé–‹ç™ºè€…</text>

  <text x="30" y="140" class="label">ãƒªãƒã‚¸ãƒˆãƒªï¼š${REPOS}</text>
  <text x="30" y="160" class="label">ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ï¼š${FOLLOWERS}</text>
  <text x="30" y="180" class="label">ã‚³ãƒŸãƒƒãƒˆ / PR / èª²é¡Œï¼š${COMMITS} / ${PRS} / ${ISSUES}</text>

  <text x="30" y="210" class="label">LV.${LEVEL} â€¢ çµŒé¨“å€¤ ${XP}</text>
  <rect x="30" y="220" width="300" height="10" fill="#333"/>
  <rect x="30" y="220" width="$((XP % 300))" height="10" class="bar"/>

  <text x="360" y="260" class="label">${DATE}</text>
</svg>
EOF

      - name: ğŸ–¼ï¸ Converter SVG para PNG
        run: |
          rsvg-convert -w 920 -h 560 japan/card.svg -o japan/card.png

      - name: ğŸ’¾ Commit e Push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add japan/
          git commit -m "ğŸˆ¶ CartÃ£o japonÃªs gerado para ${{ github.event.inputs.usuario }}" || echo "Nada a commitar"
          git push
