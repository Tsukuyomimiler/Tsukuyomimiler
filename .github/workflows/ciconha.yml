name: CICONHA CHAOS CARD

on:
  workflow_dispatch:
    inputs:
      usuario:
        description: "Seu nome de usuÃ¡rio GitHub"
        required: true
        default: "ciconha"
      empresa:
        description: "Nome da empresa (opcional)"
        required: false
        default: "Independente"
      cargo:
        description: "Cargo atual (opcional)"
        required: false
        default: "Aventureiro de CÃ³digo"
  # opcional: ativa atualizaÃ§Ã£o semanal; comente/remova se nÃ£o quiser
  schedule:
    - cron: "0 3 * * 1"

permissions:
  contents: write

jobs:
  chaos-card:
    name: Gerar Chaos Card SVGs (CICONHA)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Preparar ambiente
        run: |
          sudo apt-get update -y
          sudo apt-get install -y curl jq iconv

      - name: Coletar dados do GitHub (sanitizado)
        id: collect
        run: |
          set -euo pipefail

          USER="${{ github.event.inputs.usuario }}"
          TOKEN="${{ secrets.TSUKUYOMI_CICONHA || '' }}"

          echo "Coletando dados para: $USER"

          if [ -n "$TOKEN" ]; then
            curl -s -H "Authorization: token $TOKEN" "https://api.github.com/users/$USER" > user.json
            curl -s -H "Authorization: token $TOKEN" "https://api.github.com/users/$USER/repos?per_page=100" > repos.json
            # events pode falhar para alguns usuÃ¡rios â€” ignore erro
            curl -s -H "Authorization: token $TOKEN" "https://api.github.com/users/$USER/events?per_page=100" > events.json || true
          else
            curl -s "https://api.github.com/users/$USER" > user.json
            curl -s "https://api.github.com/users/$USER/repos?per_page=100" > repos.json
            curl -s "https://api.github.com/users/$USER/events?per_page=100" > events.json || true
          fi

          sanitize() {
            # converte para UTF-8, remove quebras de linha e aspas problemÃ¡ticas
            echo "$1" | iconv -c -t UTF-8//TRANSLIT | tr -d '\r\n' | sed 's/"/\\"/g'
          }

          LOGIN=$(jq -r '.login // ""' user.json)
          RAW_NAME=$(jq -r '.name // ""' user.json)
          RAW_BIO=$(jq -r '.bio // ""' user.json)
          AVATAR=$(jq -r '.avatar_url // ""' user.json)
          REPOS=$(jq -r '.public_repos // 0' user.json)
          FOLLOWERS=$(jq -r '.followers // 0' user.json)

          COMMITS=$(jq -r '[.[] | select(.type == "PushEvent")] | length' events.json 2>/dev/null || echo 0)
          PRS=$(jq -r '[.[] | select(.type == "PullRequestEvent")] | length' events.json 2>/dev/null || echo 0)
          ISSUES=$(jq -r '[.[] | select(.type == "IssuesEvent")] | length' events.json 2>/dev/null || echo 0)

          LANG=$(jq -r '.[].language' repos.json 2>/dev/null | sort | uniq -c | sort -nr | head -1 | awk '{print $2}' || echo "")
          if [ -z "$LANG" ] || [ "$LANG" = "null" ]; then
            LANG="Desconhecida"
          fi

          TOTAL_XP=$((REPOS * 50 + FOLLOWERS * 30 + COMMITS * 2 + PRS * 10 + ISSUES * 5))
          LEVEL=$((TOTAL_XP / 1000 + 1))
          XP_PERC=$(( (TOTAL_XP % 1000) * 100 / 1000 ))

          TOP1=$(jq -r 'sort_by(-.stargazers_count) | .[0] // {} | .name' repos.json 2>/dev/null || echo "")
          STARS_SUM=$(jq -r '[.[].stargazers_count] | add' repos.json 2>/dev/null || echo 0)

          NAME=$(sanitize "$RAW_NAME")
          BIO=$(sanitize "$RAW_BIO")
          TOP1_SAFE=$(sanitize "$TOP1")

          # SaÃ­da segura para o Actions (sem quebras de linha)
          echo "login=${LOGIN}" >> "$GITHUB_OUTPUT"
          echo "name=${NAME}" >> "$GITHUB_OUTPUT"
          echo "bio=${BIO}" >> "$GITHUB_OUTPUT"
          echo "avatar=${AVATAR}" >> "$GITHUB_OUTPUT"
          echo "repos=${REPOS}" >> "$GITHUB_OUTPUT"
          echo "followers=${FOLLOWERS}" >> "$GITHUB_OUTPUT"
          echo "commits=${COMMITS}" >> "$GITHUB_OUTPUT"
          echo "prs=${PRS}" >> "$GITHUB_OUTPUT"
          echo "issues=${ISSUES}" >> "$GITHUB_OUTPUT"
          echo "stars=${STARS_SUM}" >> "$GITHUB_OUTPUT"
          echo "top1=${TOP1_SAFE}" >> "$GITHUB_OUTPUT"
          echo "lang=${LANG}" >> "$GITHUB_OUTPUT"
          echo "total_xp=${TOTAL_XP}" >> "$GITHUB_OUTPUT"
          echo "level=${LEVEL}" >> "$GITHUB_OUTPUT"
          echo "xp_perc=${XP_PERC}" >> "$GITHUB_OUTPUT"

      - name: Gerar mÃºltiplos SVGs Cyberpunk (6 variantes) e salvar em ciconha/
        run: |
          set -euo pipefail

          USER="${{ github.event.inputs.usuario }}"
          EMPRESA="${{ github.event.inputs.empresa }}"
          CARGO="${{ github.event.inputs.cargo }}"

          NAME="${{ steps.collect.outputs.name }}"
          BIO="${{ steps.collect.outputs.bio }}"
          AVATAR="${{ steps.collect.outputs.avatar }}"
          REPOS="${{ steps.collect.outputs.repos }}"
          FOLLOWERS="${{ steps.collect.outputs.followers }}"
          STARS="${{ steps.collect.outputs.stars }}"
          TOP1="${{ steps.collect.outputs.top1 }}"
          LANG="${{ steps.collect.outputs.lang }}"
          LEVEL="${{ steps.collect.outputs.level }}"
          XP_PERC="${{ steps.collect.outputs.xp_perc }}"
          TOTAL_XP="${{ steps.collect.outputs.total_xp }}"
          DATE="$(date +'%Y-%m-%d')"

          mkdir -p ciconha

          gen_svg() {
            idx="$1"
            case "$idx" in
              1) ACC="#ff2e63"; GRA="#08d9d6"; BG="#07060a"; ;;
              2) ACC="#ffd166"; GRA="#06d6a0"; BG="#0f0b12"; ;;
              3) ACC="#e63946"; GRA="#00f5d4"; BG="#0b0d0f"; ;;
              4) ACC="#9b6bff"; GRA="#00e6ff"; BG="#080808"; ;;
              5) ACC="#ff4444"; GRA="#ff8888"; BG="#0d0000"; ;;
              6) ACC="#ff8a00"; GRA="#ffd54f"; BG="#120000"; ;;
            esac

            BAR_TOTAL=160
            FILLED=$(( BAR_TOTAL * XP_PERC / 100 ))

            cat > "ciconha/${USER}-${idx}.svg" <<EOF
<svg xmlns="http://www.w3.org/2000/svg" width="620" height="360" viewBox="0 0 620 360">
  <rect width="100%" height="100%" rx="20" fill="${BG}" />
  <g opacity="0.06"><rect x="${idx}" y="${idx}" width="620" height="360" fill="#000" /></g>

  <defs>
    <clipPath id="clip${idx}"><circle cx="60" cy="60" r="44"/></clipPath>
  </defs>

  <g transform="translate(30,30)">
    <rect x="-4" y="-4" width="128" height="128" rx="18" fill="none" stroke="${ACC}" stroke-width="2" opacity="0.9"/>
    <image href="${AVATAR}" x="0" y="0" width="120" height="120" clip-path="url(#clip${idx})" preserveAspectRatio="xMidYMid slice" />
  </g>

  <text x="170" y="60" font-family="Noto Sans JP, 'Yu Gothic', sans-serif" font-size="28" fill="${ACC}" font-weight="700">${NAME}</text>
  <text x="170" y="92" font-family="Noto Sans JP, 'Yu Gothic', sans-serif" font-size="14" fill="${GRA}">${EMPRESA} â€¢ ${CARGO} â€¢ ${LANG}</text>

  <g transform="translate(170,120)">
    <rect width="420" height="88" rx="12" fill="rgba(0,0,0,0.12)"/>
    <text x="18" y="28" font-family="monospace" font-size="12" fill="${ACC}">Repos: ${REPOS}</text>
    <text x="18" y="48" font-family="monospace" font-size="12" fill="${GRA}">Followers: ${FOLLOWERS}</text>
    <text x="220" y="28" font-family="monospace" font-size="12" fill="${ACC}">Stars: ${STARS}</text>
    <text x="220" y="48" font-family="monospace" font-size="12" fill="${GRA}">Top: ${TOP1}</text>
  </g>

  <g transform="translate(40,220)">
    <rect x="0" y="0" width="540" height="60" rx="8" fill="rgba(255,255,255,0.02)"/>
    <text x="12" y="22" font-family="Noto Sans JP, 'Yu Gothic', sans-serif" font-size="12" fill="#cccccc">${BIO}</text>
    <text x="12" y="42" font-family="Noto Sans JP, 'Yu Gothic', sans-serif" font-size="11" fill="#aaaaaa">LV.${LEVEL} â€¢ XP ${TOTAL_XP}</text>
  </g>

  <rect x="200" y="300" width="${BAR_TOTAL}" height="12" rx="6" fill="#111" opacity="0.45"/>
  <rect x="200" y="300" width="${FILLED}" height="12" rx="6" fill="${ACC}"/>
  <text x="420" y="312" font-family="monospace" font-size="11" fill="${GRA}">${XP_PERC}%</text>

  <text x="520" y="40" font-family="monospace" font-size="12" fill="${ACC}" text-anchor="end">CYBER â€¢ NANO â€¢ CHAOS</text>
  <text x="520" y="340" font-family="monospace" font-size="10" fill="#888" text-anchor="end">æ›´æ–°: ${DATE} â€¢ CICONHA</text>
</svg>
EOF
          }

          for i in 1 2 3 4 5 6; do
            gen_svg "$i"
          done

          echo "Gerados $(ls -1 ciconha | wc -l) SVGs em ciconha/"

      - name: Listar arquivos gerados
        run: |
          ls -la ciconha || true

      - name: Commit & Push SVGs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ciconha/*.svg || true
          git commit -m "ðŸ§¨ CICONHA CHAOS CARD: gerar ${{ github.event.inputs.usuario }}" || echo "Nada a commitar"
          git push --follow-tags || echo "Push falhou (talvez sem mudanÃ§as)"
