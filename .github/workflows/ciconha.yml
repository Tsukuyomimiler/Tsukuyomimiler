name: ğŸ§¨ CICONHA CHAOS CARD

on:
  schedule:
    - cron: "0 3 * * 1" # Toda segunda-feira Ã s 03:00 UTC
  workflow_dispatch:
    inputs:
      usuario:
        description: "Seu nome de usuÃ¡rio GitHub"
        required: true
        default: "ciconha"
      empresa:
        description: "Nome da empresa (opcional)"
        required: false
        default: "Independente"
      cargo:
        description: "Cargo atual (opcional)"
        required: false
        default: "Aventureiro de CÃ³digo"

permissions:
  contents: write

jobs:
  chaos-card:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ Checkout repositÃ³rio
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: âš™ï¸ Preparar ambiente
        run: |
          sudo apt-get update -y
          sudo apt-get install -y curl jq iconv

      - name: ğŸ” Coletar dados do GitHub
        id: collect
        run: |
          set -e
          USER="${{ github.event.inputs.usuario }}"
          TOKEN="${{ secrets.TSUKUYOMI_CICONHA || '' }}"
          echo "ğŸ“¡ Coletando dados do usuÃ¡rio: $USER"

          AUTH=""
          if [ -n "$TOKEN" ]; then
            AUTH="-H \"Authorization: token $TOKEN\""
          fi

          eval "curl -s $AUTH https://api.github.com/users/$USER > user.json"
          eval "curl -s $AUTH https://api.github.com/users/$USER/repos?per_page=100 > repos.json"
          eval "curl -s $AUTH https://api.github.com/users/$USER/events?per_page=100 > events.json"

          sanitize() {
            echo "$1" | iconv -c -t UTF-8//TRANSLIT | tr -d '\n' | sed 's/"/\\"/g'
          }

          LOGIN=$(jq -r '.login // ""' user.json)
          NAME=$(sanitize "$(jq -r '.name // ""' user.json)")
          BIO=$(sanitize "$(jq -r '.bio // ""' user.json)")
          AVATAR=$(jq -r '.avatar_url // ""' user.json)
          REPOS=$(jq -r '.public_repos // 0' user.json)
          FOLLOWERS=$(jq -r '.followers // 0' user.json)
          COMMITS=$(jq '[.[] | select(.type == "PushEvent")] | length' events.json)
          PRS=$(jq '[.[] | select(.type == "PullRequestEvent")] | length' events.json)
          ISSUES=$(jq '[.[] | select(.type == "IssuesEvent")] | length' events.json)
          STARS=$(jq '[.[] | .stargazers_count] | add' repos.json)
          TOP1=$(jq -r 'sort_by(-.stargazers_count) | .[0].name // "Nenhum"' repos.json)
          TOP1_DESC=$(sanitize "$(jq -r 'sort_by(-.stargazers_count) | .[0].description // "Sem descriÃ§Ã£o"' repos.json)")

          XP=$((REPOS * 50 + FOLLOWERS * 20 + COMMITS * 2 + PRS * 10 + ISSUES * 5))
          LEVEL=$((XP / 1000 + 1))
          XP_PERC=$(( (XP % 1000) * 100 / 1000 ))
          DATE=$(date +'%Yå¹´%mæœˆ%dæ—¥')
          STYLE=$((RANDOM % 4))

          echo "STYLE=$STYLE" >> $GITHUB_OUTPUT
          echo "LOGIN=$LOGIN" >> $GITHUB_OUTPUT
          echo "NAME=$NAME" >> $GITHUB_OUTPUT
          echo "BIO=$BIO" >> $GITHUB_OUTPUT
          echo "AVATAR=$AVATAR" >> $GITHUB_OUTPUT
          echo "REPOS=$REPOS" >> $GITHUB_OUTPUT
          echo "FOLLOWERS=$FOLLOWERS" >> $GITHUB_OUTPUT
          echo "COMMITS=$COMMITS" >> $GITHUB_OUTPUT
          echo "PRS=$PRS" >> $GITHUB_OUTPUT
          echo "ISSUES=$ISSUES" >> $GITHUB_OUTPUT
          echo "STARS=$STARS" >> $GITHUB_OUTPUT
          echo "TOP1=$TOP1" >> $GITHUB_OUTPUT
          echo "TOP1_DESC=$TOP1_DESC" >> $GITHUB_OUTPUT
          echo "XP=$XP" >> $GITHUB_OUTPUT
          echo "LEVEL=$LEVEL" >> $GITHUB_OUTPUT
          echo "XP_PERC=$XP_PERC" >> $GITHUB_OUTPUT
          echo "DATE=$DATE" >> $GITHUB_OUTPUT

      - name: ğŸ¨ Gerar SVG Chaos Card
        run: |
          set -e
          USER="${{ github.event.inputs.usuario }}"
          mkdir -p chaos

          STYLE="${{ steps.collect.outputs.STYLE }}"
          LOGIN="${{ steps.collect.outputs.LOGIN }}"
          NAME="${{ steps.collect.outputs.NAME }}"
          BIO="${{ steps.collect.outputs.BIO }}"
          AVATAR="${{ steps.collect.outputs.AVATAR }}"
          REPOS="${{ steps.collect.outputs.REPOS }}"
          FOLLOWERS="${{ steps.collect.outputs.FOLLOWERS }}"
          COMMITS="${{ steps.collect.outputs.COMMITS }}"
          PRS="${{ steps.collect.outputs.PRS }}"
          ISSUES="${{ steps.collect.outputs.ISSUES }}"
          STARS="${{ steps.collect.outputs.STARS }}"
          TOP1="${{ steps.collect.outputs.TOP1 }}"
          TOP1_DESC="${{ steps.collect.outputs.TOP1_DESC }}"
          XP="${{ steps.collect.outputs.XP }}"
          LEVEL="${{ steps.collect.outputs.LEVEL }}"
          XP_PERC="${{ steps.collect.outputs.XP_PERC }}"
          DATE="${{ steps.collect.outputs.DATE }}"
          EMPRESA="${{ github.event.inputs.empresa }}"
          CARGO="${{ github.event.inputs.cargo }}"

          if [ "$STYLE" = "0" ]; then
            BG="#0f1720"; ACC="#FF2E63"; GRA="#08D9D6"; FONT="'Noto Sans JP', sans-serif"
          elif [ "$STYLE" = "1" ]; then
            BG="#14121b"; ACC="#FFD166"; GRA="#06D6A0"; FONT="'Noto Sans JP', sans-serif"
          elif [ "$STYLE" = "2" ]; then
            BG="#ffffff"; ACC="#1b1b1b"; GRA="#e63946"; FONT="'Yu Gothic', sans-serif"
          else
            BG="#080808"; ACC="#7C4DFF"; GRA="#00E5FF"; FONT="'Courier New', monospace"
          fi

          BAR_TOTAL=140
          FILLED=$(( BAR_TOTAL * XP_PERC / 100 ))

          cat > "chaos/${USER}-chaos.svg" <<EOF
<svg xmlns="http://www.w3.org/2000/svg" width="460" height="220" viewBox="0 0 460 220">
  <style>
    .jp { font: bold 16px ${FONT}; fill: ${ACC}; }
    .label { font: 10px sans-serif; fill: #cfcfcf; }
    .small { font: 9px sans-serif; fill: #a8a8a8; }
    .graffiti { font: italic 12px ${FONT}; fill: ${GRA}; }
    .bg { fill: ${BG}; }
  </style>

  <rect width="100%" height="100%" class="bg" rx="18"/>
  <clipPath id="clip"><circle cx="50" cy="50" r="34"/></clipPath>

  <image href="${AVATAR}" x="16" y="16" width="68" height="68" clip-path="url(#clip)"/>
  <rect x="12" y="12" width="76" height="76" rx="12" fill="none" stroke="${ACC}" stroke-width="1.6" opacity="0.8"/>

  <text x="100" y="36" class="jp">ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼š${LOGIN}</text>
  <text x="100" y="56" class="small">${NAME} â€¢ ${EMPRESA}</text>
  <text x="100" y="74" class="label">è·æ¥­ï¼š${CARGO}</text>

  <text x="18" y="104" class="label">${BIO}</text>

  <text x="18" y="164" class="label">Commits / PRs / Issues</text>
  <text x="18" y="182" class="graffiti">${COMMITS} / ${PRS} / ${ISSUES}</text>

  <text x="18" y="202" class="label">Top: ${TOP1} â€” <tspan class="small">${TOP1_DESC}</tspan></text>

  <rect x="300" y="22" width="${BAR_TOTAL}" height="12" rx="6" fill="#222" opacity="0.5"/>
  <rect x="300" y="22" width="${FILLED}" height="12" rx="6" fill="${ACC}"/>
  <text x="370" y="18" class="small" text-anchor="middle">LV.${LEVEL} â€¢ XP ${XP}</text>

  <text x="18" y="212" font-size="10" fill="${ACC}">âš ï¸ ãƒŠãƒãƒœãƒƒãƒˆéè² è· - ãƒ‡ãƒ¼ã‚¿ç ´ç‰‡åŒ–</text>
  <text x="280" y="212" font-size="10" fill="${GRA}">CHAOS MODE â€¢ æ›´æ–°æ—¥: ${DATE}</text>
</svg>
EOF

          echo "âœ… Chaos Card SVG gerado com sucesso!"

      - name: ğŸ’¾ Commit e Push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add chaos/
          git commit -m "ğŸ§¨ Chaos Card atualizado para ${{ github.event.inputs.usuario }}" || echo "Nenhuma alteraÃ§Ã£o"
          git push
