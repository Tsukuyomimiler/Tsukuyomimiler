name: ðŸ§¨ CICONHA CHAOS CARD

on:
  # â° Executa automaticamente toda segunda-feira Ã s 03:00 UTC
  schedule:
    - cron: "0 3 * * 1"
  
  # ðŸš€ Permite rodar manualmente no GitHub Actions
  workflow_dispatch:
    inputs:
      usuario:
        description: "Seu nome de usuÃ¡rio do GitHub"
        required: true
        default: "ciconha"
      empresa:
        description: "Nome da empresa (opcional)"
        required: false
        default: "Independente"
      cargo:
        description: "Cargo atual (opcional)"
        required: false
        default: "Aventureiro de CÃ³digo"

permissions:
  contents: write

jobs:
  chaos-card:
    name: ðŸ§© Gerar Chaos Card SVG
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ”„ Checkout repositÃ³rio
        uses: actions/checkout@v4

      - name: ðŸ§° Preparar ambiente
        run: |
          sudo apt-get update -y
          sudo apt-get install -y curl jq iconv

      - name: ðŸ” Coletar dados do GitHub
        id: collect
        run: |
          set -e
          USER="${{ github.event.inputs.usuario }}"
          TOKEN="${{ secrets.TSUKUYOMI_CICONHA }}"
          echo "ðŸ›°ï¸ Coletando dados de: $USER"

          AUTH=""
          if [ -n "$TOKEN" ]; then
            AUTH="-H \"Authorization: token $TOKEN\""
          fi

          eval "curl -s $AUTH https://api.github.com/users/$USER > user.json"
          eval "curl -s $AUTH https://api.github.com/users/$USER/repos?per_page=100 > repos.json"
          eval "curl -s $AUTH https://api.github.com/users/$USER/events?per_page=100 > events.json"

          sanitize() {
            echo "$1" | iconv -c -t UTF-8//TRANSLIT | tr -d '\n' | sed 's/"/\\"/g'
          }

          LOGIN=$(jq -r '.login // ""' user.json)
          NAME=$(sanitize "$(jq -r '.name // ""' user.json)")
          BIO=$(sanitize "$(jq -r '.bio // ""' user.json)")
          AVATAR=$(jq -r '.avatar_url // ""' user.json)
          REPOS=$(jq -r '.public_repos // 0' user.json)
          FOLLOWERS=$(jq -r '.followers // 0' user.json)
          COMMITS=$(jq '[.[] | select(.type == "PushEvent")] | length' events.json)
          PRS=$(jq '[.[] | select(.type == "PullRequestEvent")] | length' events.json)
          ISSUES=$(jq '[.[] | select(.type == "IssuesEvent")] | length' events.json)
          STARS=$(jq '[.[] | .stargazers_count] | add' repos.json)
          TOP1=$(jq -r 'sort_by(-.stargazers_count) | .[0] // {} | .name' repos.json)
          TOP1_DESC=$(sanitize "$(jq -r 'sort_by(-.stargazers_count) | .[0] // {} | (.description // "Sem descriÃ§Ã£o")' repos.json)")
          TOTAL_XP=$((REPOS * 50 + FOLLOWERS * 20 + COMMITS * 2 + PRS * 10 + ISSUES * 5))
          LEVEL=$((TOTAL_XP / 1000 + 1))
          XP_PERC=$(( (TOTAL_XP % 1000) * 100 / 1000 ))
          DATE=$(date +'%Y-%m-%d')

          echo "login=${LOGIN}" >> "$GITHUB_OUTPUT"
          echo "name=${NAME}" >> "$GITHUB_OUTPUT"
          echo "bio=${BIO}" >> "$GITHUB_OUTPUT"
          echo "avatar=${AVATAR}" >> "$GITHUB_OUTPUT"
          echo "repos=${REPOS}" >> "$GITHUB_OUTPUT"
          echo "followers=${FOLLOWERS}" >> "$GITHUB_OUTPUT"
          echo "commits=${COMMITS}" >> "$GITHUB_OUTPUT"
          echo "prs=${PRS}" >> "$GITHUB_OUTPUT"
          echo "issues=${ISSUES}" >> "$GITHUB_OUTPUT"
          echo "stars=${STARS}" >> "$GITHUB_OUTPUT"
          echo "top1=${TOP1}" >> "$GITHUB_OUTPUT"
          echo "top1_desc=${TOP1_DESC}" >> "$GITHUB_OUTPUT"
          echo "xp=${TOTAL_XP}" >> "$GITHUB_OUTPUT"
          echo "level=${LEVEL}" >> "$GITHUB_OUTPUT"
          echo "xp_perc=${XP_PERC}" >> "$GITHUB_OUTPUT"
          echo "date=${DATE}" >> "$GITHUB_OUTPUT"

      - name: ðŸŽ¨ Gerar SVG
        run: |
          set -e
          mkdir -p chaos
          USER="${{ github.event.inputs.usuario }}"
          NAME="${{ steps.collect.outputs.name }}"
          BIO="${{ steps.collect.outputs.bio }}"
          AVATAR="${{ steps.collect.outputs.avatar }}"
          REPOS="${{ steps.collect.outputs.repos }}"
          FOLLOWERS="${{ steps.collect.outputs.followers }}"
          STARS="${{ steps.collect.outputs.stars }}"
          XP="${{ steps.collect.outputs.xp }}"
          LEVEL="${{ steps.collect.outputs.level }}"
          XP_PERC="${{ steps.collect.outputs.xp_perc }}"
          DATE="${{ steps.collect.outputs.date }}"
          EMPRESA="${{ github.event.inputs.empresa }}"
          CARGO="${{ github.event.inputs.cargo }}"
          BAR_TOTAL=140
          FILLED=$(( BAR_TOTAL * XP_PERC / 100 ))

          cat > "chaos/${USER}-chaos.svg" <<EOF
<svg xmlns="http://www.w3.org/2000/svg" width="460" height="220">
  <rect width="100%" height="100%" fill="#0b0d0f" rx="16"/>
  <image href="${AVATAR}" x="20" y="20" width="60" height="60" clip-path="url(#clip)"/>
  <text x="100" y="40" fill="#08d9d6" font-size="16" font-weight="bold">${NAME}</text>
  <text x="100" y="58" fill="#ff2e63" font-size="12">${EMPRESA} â€¢ ${CARGO}</text>
  <text x="20" y="100" fill="#ccc" font-size="10">${BIO}</text>
  <text x="20" y="180" fill="#08d9d6" font-size="10">LV.${LEVEL} â€¢ XP ${XP}</text>
  <rect x="20" y="160" width="${BAR_TOTAL}" height="8" rx="4" fill="#222"/>
  <rect x="20" y="160" width="${FILLED}" height="8" rx="4" fill="#ff2e63"/>
  <text x="20" y="200" fill="#777" font-size="9">Repos: ${REPOS} â€¢ Followers: ${FOLLOWERS} â€¢ Stars: ${STARS}</text>
  <text x="330" y="200" fill="#08d9d6" font-size="9">Atualizado: ${DATE}</text>
</svg>
EOF

      - name: ðŸ’¾ Commit e Push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add chaos/
          git commit -m "ðŸ§¨ Chaos Card gerado para ${{ github.event.inputs.usuario }}" || echo "Nada novo a commitar"
          git push
