name: "üë®‚Äçüíª DEV HERO CARD"

on:
  workflow_dispatch:
    inputs:
      github_user:
        description: 'Usu√°rio do GitHub'
        required: true
        default: 'ciconha'
      full_name:
        description: 'Nome completo'
        required: false
        default: ''
      company:
        description: 'Empresa/Organiza√ß√£o'
        required: false
        default: 'INSS'
      role:
        description: 'Cargo/Fun√ß√£o'
        required: false
        default: 'Desenvolvedor'
      location:
        description: 'Localiza√ß√£o'
        required: false
        default: 'Brasil'
      
      # Tech Stack
      main_language:
        description: 'Linguagem principal'
        required: false
        default: 'JavaScript'
      framework:
        description: 'Framework principal'
        required: false
        default: 'React'
      database:
        description: 'Banco de dados'
        required: false
        default: 'PostgreSQL'
      
      # Stats
      experience:
        description: 'Anos de experi√™ncia'
        required: false
        default: '2'
      availability:
        description: 'Disponibilidade (%)'
        required: false
        default: '80'

permissions:
  contents: write

jobs:
  create-dev-card:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout do reposit√≥rio
        uses: actions/checkout@v4
      
      - name: ‚öôÔ∏è Instalar depend√™ncias
        run: |
          sudo apt-get update -y
          sudo apt-get install -y curl jq
      
      - name: üîç Buscar dados do GitHub
        id: github-data
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          USER="${{ github.event.inputs.github_user }}"
          
          echo "üì° Buscando dados do GitHub para: $USER"
          
          # Limpar e sanitizar input
          USER=$(echo "$USER" | tr -cd '[:alnum:]_-')
          
          # Buscar dados do usu√°rio com fallback
          if [ -n "$GH_TOKEN" ] && [ "$GH_TOKEN" != "" ]; then
            curl -s -H "Authorization: token $GH_TOKEN" \
                 "https://api.github.com/users/$USER" > user.json || true
            curl -s -H "Authorization: token $GH_TOKEN" \
                 "https://api.github.com/users/$USER/repos?sort=stars&per_page=5" > repos.json || true
          else
            curl -s "https://api.github.com/users/$USER" > user.json || true
            curl -s "https://api.github.com/users/$USER/repos?sort=stars&per_page=5" > repos.json || true
          fi
          
          # Verificar se a resposta √© v√°lida
          if [ ! -s user.json ] || ! jq -e '.login' user.json >/dev/null 2>&1; then
            echo "‚ö†Ô∏è Usu√°rio n√£o encontrado, usando dados padr√£o"
            AVATAR_URL="https://avatars.githubusercontent.com/u/583231?v=4&size=150"
            GITHUB_NAME="$USER"
            BIO="Developer passionate about technology."
            PUBLIC_REPOS="0"
            FOLLOWERS="0"
          else
            # Extrair dados com sanitiza√ß√£o
            AVATAR_URL=$(jq -r '.avatar_url // "https://avatars.githubusercontent.com/u/583231?v=4"' user.json | sed 's/\?v=.*//; s/$/\&size=150/')
            
            BIO=$(jq -r '.bio // "Developer passionate about technology."' user.json)
            BIO=$(echo "$BIO" | tr -d '\r\n' | sed 's/"/\\"/g' | head -c 200)
            
            # Nome
            GITHUB_NAME=$(jq -r '.name // ""' user.json)
            if [ -z "$GITHUB_NAME" ] || [ "$GITHUB_NAME" = "null" ]; then
              GITHUB_NAME="$USER"
            fi
            GITHUB_NAME=$(echo "$GITHUB_NAME" | tr -d '\r\n' | head -c 50)
            
            # Stats
            PUBLIC_REPOS=$(jq -r '.public_repos // 0' user.json)
            FOLLOWERS=$(jq -r '.followers // 0' user.json)
          fi
          
          # Top projetos (com fallback)
          echo '[]' > top_projects.json
          if [ -f repos.json ] && [ -s repos.json ] && jq -e '. | length > 0' repos.json >/dev/null 2>&1; then
            jq '[.[0:3] | .[] | {name: (.name // "No name"), stars: (.stargazers_count // 0), language: (.language // "N/A")}]' repos.json > top_projects.json 2>/dev/null || echo '[]' > top_projects.json
          fi
          
          # Sanitizar outputs
          AVATAR_URL=$(echo "$AVATAR_URL" | tr -d '\r\n')
          GITHUB_NAME=$(echo "$GITHUB_NAME" | tr -d '\r\n')
          BIO=$(echo "$BIO" | tr -d '\r\n')
          
          # Outputs formatados corretamente
          echo "avatar_url=${AVATAR_URL}" >> $GITHUB_OUTPUT
          echo "github_name=${GITHUB_NAME}" >> $GITHUB_OUTPUT
          echo "bio=${BIO}" >> $GITHUB_OUTPUT
          echo "public_repos=${PUBLIC_REPOS}" >> $GITHUB_OUTPUT
          echo "followers=${FOLLOWERS}" >> $GITHUB_OUTPUT
          
          echo "‚úÖ Dados coletados com sucesso"
      
      - name: üé® Criar diret√≥rio para cards
        run: mkdir -p cards
      
      - name: üñºÔ∏è Gerar Card Dev Minimalista
        run: |
          # Dados do GitHub (com fallback)
          AVATAR_URL="${{ steps.github-data.outputs.avatar_url }}"
          if [ -z "$AVATAR_URL" ]; then
            AVATAR_URL="https://avatars.githubusercontent.com/u/583231?v=4&size=150"
          fi
          
          GITHUB_NAME="${{ steps.github-data.outputs.github_name }}"
          if [ -z "$GITHUB_NAME" ]; then
            GITHUB_NAME="${{ github.event.inputs.github_user }}"
          fi
          
          BIO="${{ steps.github-data.outputs.bio }}"
          if [ -z "$BIO" ]; then
            BIO="Developer passionate about technology."
          fi
          
          PUBLIC_REPOS="${{ steps.github-data.outputs.public_repos }}"
          FOLLOWERS="${{ steps.github-data.outputs.followers }}"
          
          # Inputs do usu√°rio com fallback
          FULL_NAME="${{ github.event.inputs.full_name }}"
          if [ -z "$FULL_NAME" ] || [ "$FULL_NAME" = "null" ] || [ "$FULL_NAME" = "" ]; then
            FULL_NAME="$GITHUB_NAME"
          fi
          
          COMPANY="${{ github.event.inputs.company }}"
          if [ -z "$COMPANY" ] || [ "$COMPANY" = "null" ]; then
            COMPANY="Not specified"
          fi
          
          ROLE="${{ github.event.inputs.role }}"
          LOCATION="${{ github.event.inputs.location }}"
          MAIN_LANG="${{ github.event.inputs.main_language }}"
          FRAMEWORK="${{ github.event.inputs.framework }}"
          DATABASE="${{ github.event.inputs.database }}"
          EXPERIENCE="${{ github.event.inputs.experience }}"
          AVAILABILITY="${{ github.event.inputs.availability }}"
          
          # Sanitizar strings para SVG
          sanitize_svg() {
            echo "$1" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g; s/"/\&quot;/g; s/'"'"'/\&apos;/g' | tr -d '\r\n' | head -c 100
          }
          
          FULL_NAME_CLEAN=$(sanitize_svg "$FULL_NAME")
          COMPANY_CLEAN=$(sanitize_svg "$COMPANY")
          ROLE_CLEAN=$(sanitize_svg "$ROLE")
          BIO_CLEAN=$(sanitize_svg "$BIO")
          LOCATION_CLEAN=$(sanitize_svg "$LOCATION")
          MAIN_LANG_CLEAN=$(sanitize_svg "$MAIN_LANG")
          FRAMEWORK_CLEAN=$(sanitize_svg "$FRAMEWORK")
          DATABASE_CLEAN=$(sanitize_svg "$DATABASE")
          
          # Ler projetos top com fallback
          PROJECT1_NAME="No projects"
          PROJECT1_STARS="0"
          PROJECT1_LANG="N/A"
          PROJECT2_NAME="No projects"
          PROJECT2_STARS="0"
          PROJECT2_LANG="N/A"
          PROJECT3_NAME="No projects"
          PROJECT3_STARS="0"
          PROJECT3_LANG="N/A"
          
          if [ -f top_projects.json ]; then
            # Projeto 1
            P1_NAME=$(jq -r '.[0].name // "No projects"' top_projects.json 2>/dev/null)
            P1_STARS=$(jq -r '.[0].stars // 0' top_projects.json 2>/dev/null)
            P1_LANG=$(jq -r '.[0].language // "N/A"' top_projects.json 2>/dev/null)
            
            if [ "$P1_NAME" != "null" ] && [ "$P1_NAME" != "" ]; then
              PROJECT1_NAME=$(sanitize_svg "$P1_NAME")
              PROJECT1_STARS="$P1_STARS"
              PROJECT1_LANG=$(sanitize_svg "$P1_LANG")
            fi
            
            # Projeto 2
            P2_NAME=$(jq -r '.[1].name // "No projects"' top_projects.json 2>/dev/null)
            P2_STARS=$(jq -r '.[1].stars // 0' top_projects.json 2>/dev/null)
            P2_LANG=$(jq -r '.[1].language // "N/A"' top_projects.json 2>/dev/null)
            
            if [ "$P2_NAME" != "null" ] && [ "$P2_NAME" != "" ]; then
              PROJECT2_NAME=$(sanitize_svg "$P2_NAME")
              PROJECT2_STARS="$P2_STARS"
              PROJECT2_LANG=$(sanitize_svg "$P2_LANG")
            fi
            
            # Projeto 3
            P3_NAME=$(jq -r '.[2].name // "No projects"' top_projects.json 2>/dev/null)
            P3_STARS=$(jq -r '.[2].stars // 0' top_projects.json 2>/dev/null)
            P3_LANG=$(jq -r '.[2].language // "N/A"' top_projects.json 2>/dev/null)
            
            if [ "$P3_NAME" != "null" ] && [ "$P3_NAME" != "" ]; then
              PROJECT3_NAME=$(sanitize_svg "$P3_NAME")
              PROJECT3_STARS="$P3_STARS"
              PROJECT3_LANG=$(sanitize_svg "$P3_LANG")
            fi
          fi
          
          # Data
          DATE=$(date +'%d/%m/%Y')
          FILENAME=$(echo "$FULL_NAME_CLEAN" | tr ' ' '_' | tr -cd '[:alnum:]_-')
          if [ -z "$FILENAME" ]; then
            FILENAME="dev_card"
          fi
          SVG_FILE="cards/${FILENAME}.svg"
          
          # Calcular barra de disponibilidade
          if [[ "$AVAILABILITY" =~ ^[0-9]+$ ]] && [ "$AVAILABILITY" -ge 0 ] && [ "$AVAILABILITY" -le 100 ]; then
            BAR_WIDTH=$((320 * AVAILABILITY / 100))
          else
            BAR_WIDTH=256  # 80% como fallback
            AVAILABILITY=80
          fi
          
          # Criar SVG com escape correto
          cat > "$SVG_FILE" << 'EOF'
          <svg xmlns="http://www.w3.org/2000/svg" width="500" height="300" viewBox="0 0 500 300">
          <defs>
            <style>
              @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@300;400&display=swap');
              
              .name { font-family: 'Inter', sans-serif; font-size: 24px; font-weight: 600; fill: #1a1a1a; }
              .title { font-family: 'Inter', sans-serif; font-size: 14px; font-weight: 500; fill: #666666; }
              .label { font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 400; fill: #888888; letter-spacing: 0.5px; text-transform: uppercase; }
              .value { font-family: 'JetBrains Mono', monospace; font-size: 11px; fill: #333333; }
              .bio { font-family: 'Inter', sans-serif; font-size: 12px; fill: #444444; line-height: 1.4; }
              .project-name { font-family: 'JetBrains Mono', monospace; font-size: 10px; fill: #1a1a1a; }
              .project-stats { font-family: 'Inter', sans-serif; font-size: 9px; fill: #666666; }
            </style>
            
            <!-- Gradiente sutil -->
            <linearGradient id="bgGradient" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" stop-color="#ffffff"/>
              <stop offset="100%" stop-color="#f8f9fa"/>
            </linearGradient>
            
            <linearGradient id="expBar" x1="0%" y1="0%" x2="100%" y2="0%">
              <stop offset="0%" stop-color="#2563eb"/>
              <stop offset="100%" stop-color="#3b82f6"/>
            </linearGradient>
          </defs>
          
          <!-- Fundo clean -->
          <rect width="500" height="300" fill="url(#bgGradient)"/>
          <rect x="20" y="20" width="460" height="260" rx="12" fill="white" stroke="#e5e7eb" stroke-width="1"/>
          
          <!-- Avatar -->
          <defs>
            <clipPath id="avatarClip">
              <circle cx="70" cy="70" r="30"/>
            </clipPath>
          </defs>
          
          <circle cx="70" cy="70" r="32" fill="#f3f4f6"/>
          <circle cx="70" cy="70" r="30" fill="#f8fafc"/>
          <image href="
EOF
          # Inserir URL do avatar (escapada)
          echo "$AVATAR_URL" >> "$SVG_FILE"
          
          cat >> "$SVG_FILE" << EOF
          " x="40" y="40" width="60" height="60" clip-path="url(#avatarClip)"/>
          
          <!-- Nome e t√≠tulo -->
          <text x="120" y="55" class="name">$FULL_NAME_CLEAN</text>
          <text x="120" y="75" class="title">$ROLE_CLEAN ‚Ä¢ $COMPANY_CLEAN</text>
          
          <!-- Bio -->
          <text x="120" y="95" class="label">SOBRE</text>
          <text x="120" y="110" class="bio">$BIO_CLEAN</text>
          
          <!-- Stats do GitHub -->
          <g transform="translate(120, 130)">
            <rect x="0" y="0" width="100" height="30" rx="6" fill="#f8fafc"/>
            <text x="10" y="12" class="label">Repos</text>
            <text x="10" y="24" class="value" font-weight="600">$PUBLIC_REPOS</text>
            
            <rect x="110" y="0" width="100" height="30" rx="6" fill="#f8fafc"/>
            <text x="120" y="12" class="label">Followers</text>
            <text x="120" y="24" class="value" font-weight="600">$FOLLOWERS</text>
            
            <rect x="220" y="0" width="100" height="30" rx="6" fill="#f8fafc"/>
            <text x="230" y="12" class="label">Exp</text>
            <text x="230" y="24" class="value" font-weight="600">${EXPERIENCE}y</text>
          </g>
          
          <!-- Tech Stack -->
          <g transform="translate(20, 170)">
            <text x="0" y="0" class="label">TECH STACK</text>
            
            <g transform="translate(0, 15)">
              <rect x="0" y="0" width="140" height="25" rx="4" fill="#eff6ff"/>
              <text x="10" y="16" class="value">$MAIN_LANG_CLEAN</text>
              
              <rect x="150" y="0" width="140" height="25" rx="4" fill="#f0f9ff"/>
              <text x="160" y="16" class="value">$FRAMEWORK_CLEAN</text>
              
              <rect x="300" y="0" width="140" height="25" rx="4" fill="#f0fdf4"/>
              <text x="310" y="16" class="value">$DATABASE_CLEAN</text>
            </g>
          </g>
          
          <!-- Barra de disponibilidade -->
          <g transform="translate(20, 220)">
            <text x="0" y="0" class="label">AVAILABILITY</text>
            <rect x="0" y="10" width="320" height="8" rx="4" fill="#e5e7eb"/>
            <rect x="0" y="10" width="$BAR_WIDTH" height="8" rx="4" fill="url(#expBar)"/>
            <text x="330" y="15" class="value">${AVAILABILITY}%</text>
          </g>
          
          <!-- Projetos Top -->
          <g transform="translate(20, 245)">
            <text x="0" y="0" class="label">TOP PROJECTS</text>
            
            <g transform="translate(0, 15)">
              <!-- Projeto 1 -->
              <rect x="0" y="0" width="140" height="40" rx="6" fill="#f8fafc"/>
              <text x="10" y="15" class="project-name">$PROJECT1_NAME</text>
              <text x="10" y="28" class="project-stats">‚≠ê $PROJECT1_STARS ‚Ä¢ $PROJECT1_LANG</text>
              
              <!-- Projeto 2 -->
              <rect x="150" y="0" width="140" height="40" rx="6" fill="#f8fafc"/>
              <text x="160" y="15" class="project-name">$PROJECT2_NAME</text>
              <text x="160" y="28" class="project-stats">‚≠ê $PROJECT2_STARS ‚Ä¢ $PROJECT2_LANG</text>
              
              <!-- Projeto 3 -->
              <rect x="300" y="0" width="140" height="40" rx="6" fill="#f8fafc"/>
              <text x="310" y="15" class="project-name">$PROJECT3_NAME</text>
              <text x="310" y="28" class="project-stats">‚≠ê $PROJECT3_STARS ‚Ä¢ $PROJECT3_LANG</text>
            </g>
          </g>
          
          <!-- Footer -->
          <g transform="translate(20, 290)">
            <text x="0" y="0" class="label">üìç $LOCATION_CLEAN</text>
            <text x="350" y="0" class="label" text-anchor="end">Updated: $DATE</text>
          </g>
          
          <!-- Linhas decorativas minimalistas -->
          <line x1="20" y1="165" x2="480" y2="165" stroke="#e5e7eb" stroke-width="1"/>
          <line x1="20" y1="215" x2="480" y2="215" stroke="#e5e7eb" stroke-width="1"/>
          <line x1="20" y1="240" x2="480" y2="240" stroke="#e5e7eb" stroke-width="1"/>
          
          </svg>
EOF
          
          echo "‚úÖ Card Dev criado: $SVG_FILE"
          echo "üë®‚Äçüíª Design: Minimalista Dev"
          echo "üìä Stats: $PUBLIC_REPOS repos, $FOLLOWERS followers"
          echo "‚≠ê Top Projeto: $PROJECT1_NAME ($PROJECT1_STARS ‚≠ê)"
      
      - name: üì§ Salvar card
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          
          git add cards/
          git commit -m "üë®‚Äçüíª Add dev card: ${{ github.event.inputs.github_user }}" || echo "Sem altera√ß√µes"
          git push || echo "Push falhou ou sem altera√ß√µes"
          echo "‚úÖ Workflow completo!"
