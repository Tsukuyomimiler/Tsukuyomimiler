name: Guild Card Generator

on:
  workflow_dispatch:
    inputs:
      github_user:
        description: "Nome do usuÃ¡rio GitHub"
        required: true
        default: "ciconha"
      theme_color:
        description: "Cor principal do card (hex)"
        required: false
        default: "#4caf50"

jobs:
  build-card:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm install node-fetch@2 canvas@2

      - name: Generate SVG Card
        run: |
          node -e "
          const fs = require('fs');
          const fetch = require('node-fetch');
          const { createCanvas, loadImage } = require('canvas');

          const username = process.env.GITHUB_USER || '${{ github.event.inputs.github_user }}';
          const theme = process.env.THEME_COLOR || '${{ github.event.inputs.theme_color }}';

          async function generateCard() {
            const res = await fetch(\`https://api.github.com/users/\${username}\`);
            const data = await res.json();

            const width = 600, height = 220;
            const canvas = createCanvas(width, height);
            const ctx = canvas.getContext('2d');

            // Fundo
            ctx.fillStyle = '#1e1e2e';
            ctx.fillRect(0, 0, width, height);

            // Avatar
            try {
              const avatar = await loadImage(data.avatar_url);
              ctx.save();
              ctx.beginPath();
              ctx.arc(80, 80, 50, 0, Math.PI * 2);
              ctx.closePath();
              ctx.clip();
              ctx.drawImage(avatar, 30, 30, 100, 100);
              ctx.restore();
            } catch (err) {
              console.error('Erro ao carregar avatar:', err);
            }

            // Nome e bio
            ctx.fillStyle = theme;
            ctx.font = 'bold 28px Arial';
            ctx.fillText(data.name || username, 150, 70);

            ctx.fillStyle = '#fff';
            ctx.font = '18px Arial';
            ctx.fillText('@' + username, 150, 100);

            ctx.fillStyle = '#ccc';
            ctx.font = '14px Arial';
            const bio = data.bio ? data.bio.substring(0, 70) : 'Desenvolvedor apaixonado por tecnologia ðŸš€';
            ctx.fillText(bio, 150, 130);

            // Linha decorativa
            ctx.strokeStyle = theme;
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(150, 140);
            ctx.lineTo(550, 140);
            ctx.stroke();

            // Stats
            ctx.font = '16px Arial';
            ctx.fillStyle = '#fff';
            ctx.fillText(\`RepositÃ³rios PÃºblicos: \${data.public_repos}\`, 150, 170);
            ctx.fillText(\`Seguidores: \${data.followers}\`, 150, 190);
            ctx.fillText(\`Seguindo: \${data.following}\`, 150, 210);

            // Salvar SVG
            const buffer = canvas.toBuffer('image/png');
            const svgPath = './guild-card.png';
            fs.writeFileSync(svgPath, buffer);
            console.log('âœ… Card gerado em', svgPath);
          }

          generateCard();
          "
        env:
          GITHUB_USER: ${{ github.event.inputs.github_user }}
          THEME_COLOR: ${{ github.event.inputs.theme_color }}

      - name: Commit and Push Generated Card
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add guild-card.png
          git commit -m "ðŸ”„ AtualizaÃ§Ã£o automÃ¡tica do Guild Card"
          git push
