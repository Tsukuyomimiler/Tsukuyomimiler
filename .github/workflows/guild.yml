name: Recreate Guild Card (Node) - Organized

on:
  workflow_dispatch:

env:
  OUTPUT_IMAGE: recreated_card.png
  CHARACTER_FILE: character.yml
  NODE_VERSION: '18'

jobs:
  validate:
    name: Validate Manual Trigger
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Confirm manual run
        run: |
          echo "Workflow disparado manualmente com sucesso"
          echo "Verifique o job generate-guild-card para gerar a imagem."

  generate-guild-card:
    name: Generate Guild Card PNG
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install system dependencies for node-canvas
        run: |
          sudo apt-get update -y
          sudo apt-get install -y build-essential libcairo2-dev libpango1.0-dev libjpeg-dev libgif-dev librsvg2-dev

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Ensure character.yml exists
        run: |
          if [ ! -f "${{ env.CHARACTER_FILE }}" ]; then
            cat > "${{ env.CHARACTER_FILE }}" <<'YML'
name: "H/N"
class: "Superhero"
guild: "14Ball Official"
gender: "M"
age: 17
race: "Human"
inv: "Being from another dimension, H/N doesn’t have any powers. Though, being a very good fighter mixed with having knowledge of most everything makes him a formidable adversary."
lvl: 2
stats:
  STRENGTH: 7
  HEALTH: 8
  MAGIC_POW: 0
  DEXTERITY: 9
  AGILITY: 6
  LUK: 9
active_skills:
  - "Determination"
  - "Spinjitzu"
superhero_ranking: "D"
YML
            echo "Arquivo character.yml criado como exemplo."
          else
            echo "character.yml já existe, usando o arquivo do repositório."
          fi

      - name: Initialize npm and install packages
        run: |
          if [ ! -f package.json ]; then
            npm init -y
          fi
          npm install canvas@2 yamljs

      - name: Add Node script to generate card
        run: |
          cat > generate_card.js <<'JS'
const fs = require('fs');
const YAML = require('yamljs');
const { createCanvas, registerFont } = require('canvas');

// Optional: register a font file if you add one to the repo (uncomment and add font to /fonts)
// registerFont('fonts/EbGaramond-Regular.ttf', { family: 'EbGaramond' });

const data = YAML.load('character.yml');

// Canvas size
const W = 1600;
const H = 1000;
const canvas = createCanvas(W, H);
const ctx = canvas.getContext('2d');

// Colors
const paper = '#F5EBD2';
const border = '#3C2814';
const accent = '#785028';
const textColor = '#1E140A';
const iconColor = '#50321E';

// Clear (transparent background)
ctx.clearRect(0, 0, W, H);

// Rounded rectangle helper
function roundRect(x, y, w, h, r) {
  ctx.beginPath();
  ctx.moveTo(x + r, y);
  ctx.arcTo(x + w, y, x + w, y + h, r);
  ctx.arcTo(x + w, y + h, x, y + h, r);
  ctx.arcTo(x, y + h, x, y, r);
  ctx.arcTo(x, y, x + w, y, r);
  ctx.closePath();
}

// Draw card
const margin = 60;
const cardX = margin;
const cardY = margin;
const cardW = W - margin*2;
const cardH = H - margin*2;
roundRect(cardX, cardY, cardW, cardH, 24);
ctx.fillStyle = paper;
ctx.fill();
ctx.lineWidth = 6;
ctx.strokeStyle = border;
ctx.stroke();

// Inner border
ctx.lineWidth = 3;
ctx.strokeStyle = accent;
roundRect(cardX + 28, cardY + 28, cardW - 56, cardH - 56, 18);
ctx.stroke();

// Fonts
const headerFont = '36px serif';
const titleFont = '48px serif';
const bodyFont = '28px serif';
const monoFont = '22px monospace';

// Top-left labels
const labelsX = cardX + 60;
let labelsY = cardY + 60;
const labelW = 420;
const labelH = 64;
const gap = 12;

function drawLabel(x, y, w, h, label, value) {
  ctx.lineWidth = 3;
  ctx.strokeStyle = border;
  ctx.strokeRect(x, y, w, h);
  ctx.fillStyle = textColor;
  ctx.font = headerFont;
  ctx.fillText(`${label}: ${value}`, x + 12, y + 42);
}

drawLabel(labelsX, labelsY, labelW, labelH, 'NAME', data.name || 'H/N');
labelsY += labelH + gap;
drawLabel(labelsX, labelsY, labelW, labelH, 'CLASS', data.class || 'Superhero');
labelsY += labelH + gap;
drawLabel(labelsX, labelsY, labelW, labelH, 'GUILD', data.guild || '14Ball Official');

// Top-right silhouette box
const silX = cardX + cardW - 320;
const silY = cardY + 60;
const silW = 220;
const silH = 220;
ctx.lineWidth = 3;
ctx.strokeStyle = border;
ctx.strokeRect(silX, silY, silW, silH);

// silhouette
ctx.fillStyle = iconColor;
const cx = silX + silW/2;
const cy = silY + silH/2 - 10;
ctx.beginPath();
ctx.ellipse(cx, cy - 30, 40, 40, 0, 0, Math.PI*2);
ctx.fill();
ctx.fillRect(cx - 60, cy - 10, 120, 90);

// basic info row under silhouette
ctx.fillStyle = textColor;
ctx.font = bodyFont;
ctx.fillText(`AGE: ${data.age || 17}   RACE: ${data.race || 'Human'}   GENDER: ${data.gender || 'M'}`, silX, silY + silH + 36);

// Inventory paragraph
const invX = labelsX;
const invY = cardY + 60 + 3*(labelH + gap) + 20;
const invW = cardW - (labelsX - cardX) - 60 - silW - 20;
ctx.font = bodyFont;
const invText = data.inv || '';
function wrapText(text, x, y, maxWidth, lineHeight) {
  const words = text.split(' ');
  let line = '';
  for (let n = 0; n < words.length; n++) {
    const testLine = line + (line ? ' ' : '') + words[n];
    const metrics = ctx.measureText(testLine);
    if (metrics.width > maxWidth && n > 0) {
      ctx.fillText(line, x, y);
      line = words[n];
      y += lineHeight;
    } else {
      line = testLine;
    }
  }
  if (line) ctx.fillText(line, x, y);
  return y + lineHeight;
}
let curY = wrapText(invText, invX, invY, invW, 36);

// Stats column
const statsX = labelsX;
const statsY = curY + 20;
const statsW = 520;
ctx.font = headerFont;
ctx.fillText('STATS // SKILLS', statsX, statsY);
ctx.font = bodyFont;
let lineY = statsY + 48;
const stats = data.stats || {};
const statOrder = ['STRENGTH','HEALTH','MAGIC_POW','DEXTERITY','AGILITY','LUK'];
for (const key of statOrder) {
  const val = stats[key] !== undefined ? stats[key] : (key === 'MAGIC_POW' ? 0 : '');
  ctx.strokeStyle = accent;
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(statsX, lineY + 18);
  ctx.lineTo(statsX + statsW - 20, lineY + 18);
  ctx.stroke();
  ctx.fillStyle = textColor;
  ctx.fillText(key.replace('_',' '), statsX + 6, lineY + 28);
  ctx.fillText(String(val), statsX + statsW - 60, lineY + 28);
  lineY += 44;
}

// Active skills column
const skillsX = statsX + statsW + 40;
const skillsY = statsY;
const skillsW = 360;
ctx.font = headerFont;
ctx.fillText('ACTIVE SKILLS', skillsX, skillsY);
ctx.strokeStyle = accent;
ctx.lineWidth = 1;
ctx.beginPath();
ctx.moveTo(skillsX, skillsY + 48);
ctx.lineTo(skillsX + skillsW, skillsY + 48);
ctx.stroke();
ctx.font = bodyFont;
const skills = data.active_skills || [];
let sy = skillsY + 64;
for (const s of skills) {
  ctx.fillText('• ' + s, skillsX + 6, sy);
  sy += 40;
}

// LVL box
const lvlX = skillsX + skillsW + 20;
const lvlY = skillsY + 20;
ctx.lineWidth = 3;
ctx.strokeStyle = border;
ctx.strokeRect(lvlX, lvlY, 120, 120);
ctx.font = headerFont;
ctx.fillStyle = textColor;
ctx.fillText('LVL', lvlX + 18, lvlY + 48);
ctx.font = titleFont;
ctx.fillText(String(data.lvl || 2), lvlX + 46, lvlY + 84);

// Superhero ranking column
const rankX = lvlX + 160;
const rankY = skillsY;
ctx.font = bodyFont;
ctx.fillText('SUPERHERO RANKING', rankX, rankY);
ctx.strokeStyle = iconColor;
ctx.lineWidth = 2;
let iconStartY = rankY + 48;
// diamond
ctx.beginPath();
ctx.moveTo(rankX + 80, iconStartY);
ctx.lineTo(rankX + 152, iconStartY + 18);
ctx.lineTo(rankX + 80, iconStartY + 36);
ctx.lineTo(rankX + 8, iconStartY + 18);
ctx.closePath();
ctx.stroke();
iconStartY += 56;
// four small squares
for (let i = 0; i < 4; i++) {
  const sx = rankX + 12 + (i%2)*56;
  const sy2 = iconStartY + Math.floor(i/2)*56;
  ctx.strokeRect(sx, sy2, 40, 40);
}
iconStartY += 120;
// center circle
ctx.beginPath();
ctx.arc(rankX + 80, iconStartY, 18, 0, Math.PI*2);
ctx.stroke();
iconStartY += 72;
// sun-like
ctx.beginPath();
ctx.arc(rankX + 80, iconStartY, 22, 0, Math.PI*2);
ctx.stroke();

// footer
ctx.font = monoFont;
ctx.fillStyle = textColor;
ctx.fillText(`SUPERHERO RANKING: ${data.superhero_ranking || 'D'}`, cardX + 60, cardY + cardH - 40);

// Save PNG
const out = fs.createWriteStream('recreated_card.png');
const stream = canvas.createPNGStream();
stream.pipe(out);
out.on('finish', () => console.log('Saved recreated_card.png'));
JS

      - name: Run Node script to generate card
        run: |
          node generate_card.js

      - name: Upload generated image
        uses: actions/upload-artifact@v4
        with:
          name: recreated-card
          path: ${{ env.OUTPUT_IMAGE }}
