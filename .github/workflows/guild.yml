name: üõ°Ô∏è Card Guild (Dark Red Minimal Pro Edition)

on:
  schedule:
    - cron: '0 12 * * *' # Atualiza diariamente √†s 12h UTC (~9h no Brasil)
  workflow_dispatch:
    inputs:
      usuario:
        description: 'Usu√°rio do GitHub (ex: ciconha)'
        required: true
        default: 'ciconha'
      empresa:
        description: 'Nome da empresa (ex: TechLabs Studio)'
        required: false
        default: 'INSS'
      cargo:
        description: 'Cargo atual (ex: Desenvolvedor Back-end)'
        required: false
        default: 'Estagi√°rio de TI'

permissions:
  contents: write

jobs:
  gerar-svg:
    runs-on: ubuntu-latest
    steps:
      - name: üß© Checkout do reposit√≥rio
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Instalar depend√™ncias
        run: |
          sudo apt-get update -y
          sudo apt-get install -y curl jq moreutils ca-certificates

      - name: üîç Buscar dados do GitHub
        id: fetch-data
        env:
          GITHUB_API_TOKEN: ${{ secrets.GITHUB_API_TOKEN }}
        run: |
          set -euo pipefail
          USER="${{ github.event.inputs.usuario }}"
          TOKEN="${GITHUB_API_TOKEN:-}"

          echo "üì° Coletando dados do usu√°rio: $USER"

          AUTH_HEADER=""
          if [ -n "$TOKEN" ]; then
            AUTH_HEADER="-H \"Authorization: token $TOKEN\""
          fi

          # Buscar dados (usa curl com -sL)
          eval "curl -sL $AUTH_HEADER \"https://api.github.com/users/$USER\" > user.json"
          eval "curl -sL $AUTH_HEADER \"https://api.github.com/users/$USER/repos?per_page=100\" > repos.json"
          eval "curl -sL $AUTH_HEADER \"https://api.github.com/users/$USER/events?per_page=300\" > events.json || true"

          sanitize() {
            echo "$1" | iconv -c -t UTF-8//TRANSLIT | tr -d '\n' | sed 's/\"/\\"/g'
          }

          LOGIN=$(jq -r '.login // ""' user.json)
          NAME=$(jq -r '.name // ""' user.json)
          if [ -z "$NAME" ]; then NAME="$LOGIN"; fi
          BIO=$(jq -r '.bio // "Desenvolvedor apaixonado por tecnologia."' user.json)
          REPOS=$(jq -r '.public_repos // 0' user.json)
          FOLLOWERS=$(jq -r '.followers // 0' user.json)
          AVATAR_URL=$(jq -r '.avatar_url // ""' user.json)

          COMMITS=$(jq '[.[] | select(.type == "PushEvent")] | length' events.json 2>/dev/null || echo 0)
          PRS=$(jq '[.[] | select(.type == "PullRequestEvent")] | length' events.json 2>/dev/null || echo 0)
          ISSUES=$(jq '[.[] | select(.type == "IssuesEvent")] | length' events.json 2>/dev/null || echo 0)

          LANG=$(jq -r '.[].language' repos.json 2>/dev/null | sort | uniq -c | sort -nr | head -1 | awk '{print $2}')
          if [ -z "$LANG" ] || [ "$LANG" = "null" ]; then
            LANG="Desconhecida"
          fi

          # XP e classifica√ß√£o
          TOTAL_XP=$((REPOS * 50 + FOLLOWERS * 30 + COMMITS * 2 + PRS * 10 + ISSUES * 5))
          LEVEL=$((TOTAL_XP / 1000 + 1))
          XP_PERCENTAGE=$(( (TOTAL_XP % 1000) * 100 / 1000 ))

          if [ "$REPOS" -gt 50 ]; then
            CLASS="Arquiteto"
          elif [ "$FOLLOWERS" -gt 100 ]; then
            CLASS="Lenda"
          elif [ "$REPOS" -gt 30 ] && [ "$FOLLOWERS" -gt 50 ]; then
            CLASS="Mestre"
          else
            CLASS="Aventureiro"
          fi

          if [ "$REPOS" -gt 100 ]; then
            RANK="Lend√°rio"
          elif [ "$REPOS" -gt 50 ]; then
            RANK="√âpico"
          else
            RANK="Her√≥i"
          fi

          jq 'sort_by(-.stargazers_count) | .[0:2] | map({name: .name, stars: .stargazers_count})' repos.json > top_projects.json || echo "[]" > top_projects.json

          echo "login=$LOGIN" >> $GITHUB_OUTPUT
          echo "name=$NAME" >> $GITHUB_OUTPUT
          echo "bio=$BIO" >> $GITHUB_OUTPUT
          echo "repos=$REPOS" >> $GITHUB_OUTPUT
          echo "followers=$FOLLOWERS" >> $GITHUB_OUTPUT
          echo "commits=$COMMITS" >> $GITHUB_OUTPUT
          echo "prs=$PRS" >> $GITHUB_OUTPUT
          echo "issues=$ISSUES" >> $GITHUB_OUTPUT
          echo "lang=$LANG" >> $GITHUB_OUTPUT
          echo "total_xp=$TOTAL_XP" >> $GITHUB_OUTPUT
          echo "level=$LEVEL" >> $GITHUB_OUTPUT
          echo "xp_percentage=$XP_PERCENTAGE" >> $GITHUB_OUTPUT
          echo "class=$CLASS" >> $GITHUB_OUTPUT
          echo "rank=$RANK" >> $GITHUB_OUTPUT
          echo "avatar_url=$AVATAR_URL" >> $GITHUB_OUTPUT

      - name: üé® Gerar SVG Dark Red Minimalista
        run: |
          set -euo pipefail
          mkdir -p cards
          USER="${{ github.event.inputs.usuario }}"
          NAME="${{ steps.fetch-data.outputs.name }}"
          LOGIN="${{ steps.fetch-data.outputs.login }}"
          BIO="${{ steps.fetch-data.outputs.bio }}"
          REPOS="${{ steps.fetch-data.outputs.repos }}"
          FOLLOWERS="${{ steps.fetch-data.outputs.followers }}"
          LANG="${{ steps.fetch-data.outputs.lang }}"
          LEVEL="${{ steps.fetch-data.outputs.level }}"
          TOTAL_XP="${{ steps.fetch-data.outputs.total_xp }}"
          XP_PERCENTAGE="${{ steps.fetch-data.outputs.xp_percentage }}"
          CLASS="${{ steps.fetch-data.outputs.class }}"
          RANK="${{ steps.fetch-data.outputs.rank }}"
          COMMITS="${{ steps.fetch-data.outputs.commits }}"
          PRS="${{ steps.fetch-data.outputs.prs }}"
          ISSUES="${{ steps.fetch-data.outputs.issues }}"
          AVATAR_URL="${{ steps.fetch-data.outputs.avatar_url }}"
          EMPRESA="${{ github.event.inputs.empresa }}"
          CARGO="${{ github.event.inputs.cargo }}"

          PROJECT1_NAME=$(jq -r '.[0].name // ""' top_projects.json)
          PROJECT1_STARS=$(jq -r '.[0].stars // 0' top_projects.json)
          PROJECT2_NAME=$(jq -r '.[1].name // ""' top_projects.json)
          PROJECT2_STARS=$(jq -r '.[1].stars // 0' top_projects.json)

          CURRENT_DATE=$(date +'%d/%m/%Y')
          BAR_MAX=280
          BAR_WIDTH=$(( BAR_MAX * XP_PERCENTAGE / 100 ))

          cat > cards/${USER}.svg <<EOF
<svg xmlns="http://www.w3.org/2000/svg" width="460" height="280" viewBox="0 0 460 280">
  <defs>
    <linearGradient id="darkRed" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" stop-color="#120000"/>
      <stop offset="100%" stop-color="#360000"/>
    </linearGradient>
    <style>
      .title { font-size: 22px; font-weight: bold; fill: #FF3333; }
      .subtitle { font-size: 13px; fill: #FF7777; }
      .text { font-size: 11px; fill: #FFAAAA; }
      .bar-bg { fill: #1a0000; }
      .bar-fill { fill: #FF2222; }
      .small { font-size: 10px; fill: #ffbfcf; }
    </style>
  </defs>

  <rect width="460" height="280" rx="15" ry="15" fill="url(#darkRed)" stroke="#880000" stroke-width="3"/>

  <!-- Cabe√ßalho -->
  <text x="30" y="55" class="title">${NAME}</text>
  <text x="30" y="75" class="subtitle">üè¢ ${EMPRESA} ‚Ä¢ üíº ${CARGO}</text>
  <text x="30" y="93" class="subtitle">‚öîÔ∏è ${CLASS} ‚Ä¢ ü©∏ ${RANK}</text>

  <!-- Bio -->
  <text x="30" y="115" class="text">${BIO}</text>

  <!-- Linguagem + XP -->
  <text x="30" y="140" class="text">üíª Linguagem principal: ${LANG}</text>
  <text x="30" y="158" class="text">üèÜ N√≠vel: ${LEVEL} ‚Ä¢ XP Total: ${TOTAL_XP}</text>

  <!-- Barra de XP -->
  <rect x="30" y="165" width="${BAR_MAX}" height="8" class="bar-bg" rx="4" ry="4"/>
  <rect x="30" y="165" width="${BAR_WIDTH}" height="8" class="bar-fill" rx="4" ry="4"/>

  <!-- Projetos -->
  <text x="30" y="195" class="subtitle">‚≠ê Destaques:</text>
  <text x="30" y="215" class="text">‚Ä¢ ${PROJECT1_NAME} ‚Äî ‚≠ê ${PROJECT1_STARS}</text>
  <text x="30" y="232" class="text">‚Ä¢ ${PROJECT2_NAME} ‚Äî ‚≠ê ${PROJECT2_STARS}</text>

  <!-- Rodap√© -->
  <text x="230" y="265" text-anchor="middle" class="small">
    Gerado em ${CURRENT_DATE} ‚Ä¢ ${COMMITS} commits ‚Ä¢ ${PRS} PRs ‚Ä¢ ${ISSUES} issues
  </text>
</svg>
EOF

          echo "‚úÖ SVG gerado: cards/${USER}.svg"

      - name: üíæ Commit e Push autom√°tico
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add cards/
          git commit -m "ü©∏ Atualiza√ß√£o do cart√£o da guilda para ${{ github.event.inputs.usuario }}" || echo "Nenhuma mudan√ßa detectada"
          git push
