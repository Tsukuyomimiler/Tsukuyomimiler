name: üõ°Ô∏è Card Guild (Dark Neon Dark Red ‚Äî Ultra Edition)

on:
  schedule:
    - cron: '0 12 * * *' # Atualiza diariamente √†s 12h UTC (~9h no Brasil)
  workflow_dispatch:
    inputs:
      usuario:
        description: 'Usu√°rio do GitHub (ex: ciconha)'
        required: true
        default: 'ciconha'
      empresa:
        description: 'Nome da empresa (ex: TechLabs Studio)'
        required: false
        default: 'INSS'
      cargo:
        description: 'Cargo atual (ex: Desenvolvedor Back-end)'
        required: false
        default: 'Estagi√°rio de TI'

permissions:
  contents: write

jobs:
  gerar-svg:
    runs-on: ubuntu-latest
    steps:
      - name: üß© Checkout do reposit√≥rio
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Instalar depend√™ncias
        run: |
          sudo apt-get update -y
          sudo apt-get install -y curl jq moreutils ca-certificates

      - name: üîç Buscar dados do GitHub
        id: fetch-data
        env:
          GITHUB_API_TOKEN: ${{ secrets.TSUKUYOMI_CICONHA }}
        run: |
          USER="${{ github.event.inputs.usuario }}"
          TOKEN="$GITHUB_API_TOKEN"

          echo "üì° Coletando dados do usu√°rio: $USER"

          # Requisi√ß√µes √† API (com token para evitar rate-limit)
          curl -s -H "Authorization: token $TOKEN" "https://api.github.com/users/$USER" > user.json
          curl -s -H "Authorization: token $TOKEN" "https://api.github.com/users/$USER/repos?per_page=100" > repos.json
          curl -s -H "Authorization: token $TOKEN" "https://api.github.com/users/$USER/events?per_page=300" > events.json

          sanitize() {
            echo "$1" | iconv -c -t UTF-8//TRANSLIT | tr -d '\n' | sed 's/"/\\"/g'
          }

          LOGIN=$(sanitize "$(jq -r '.login // ""' user.json)")
          NAME=$(sanitize "$(jq -r '.name // ""' user.json)")
          if [ -z "$NAME" ]; then NAME="$LOGIN"; fi
          BIO=$(sanitize "$(jq -r '.bio // "Desenvolvedor apaixonado por tecnologia."' user.json)")
          REPOS=$(jq -r '.public_repos // 0' user.json)
          FOLLOWERS=$(jq -r '.followers // 0' user.json)
          AVATAR_URL=$(jq -r '.avatar_url // ""' user.json)

          COMMITS=$(jq '[.[] | select(.type == "PushEvent")] | length' events.json)
          PRS=$(jq '[.[] | select(.type == "PullRequestEvent")] | length' events.json)
          ISSUES=$(jq '[.[] | select(.type == "IssuesEvent")] | length' events.json)

          LANG=$(jq -r '.[].language' repos.json | sort | uniq -c | sort -nr | head -1 | awk '{print $2}')
          if [ -z "$LANG" ] || [ "$LANG" = "null" ]; then
            LANG="Desconhecida"
          fi

          # XP e classifica√ß√£o (ajustado para escala mais "absurda")
          TOTAL_XP=$((REPOS * 120 + FOLLOWERS * 80 + COMMITS * 5 + PRS * 25 + ISSUES * 10))
          LEVEL=$((TOTAL_XP / 1500 + 1))
          XP_PERCENTAGE=$(( (TOTAL_XP % 1500) * 100 / 1500 ))

          if [ "$REPOS" -gt 150 ]; then
            CLASS="Arquimago"
          elif [ "$FOLLOWERS" -gt 1000 ]; then
            CLASS="Lenda Suprema"
          elif [ "$REPOS" -gt 60 ] && [ "$FOLLOWERS" -gt 200 ]; then
            CLASS="Mestre"
          else
            CLASS="Aventureiro"
          fi

          if [ "$REPOS" -gt 200 ]; then
            RANK="Lend√°rio"
          elif [ "$REPOS" -gt 80 ]; then
            RANK="√âpico"
          else
            RANK="Her√≥i"
          fi

          # Top 2 projetos (nome e estrelas)
          jq 'sort_by(-.stargazers_count) | .[0:2] | map({name: .name, stars: .stargazers_count})' repos.json > top_projects.json

          # Export outputs
          echo "login=$LOGIN" >> $GITHUB_OUTPUT
          echo "name=$NAME" >> $GITHUB_OUTPUT
          echo "bio=$BIO" >> $GITHUB_OUTPUT
          echo "repos=$REPOS" >> $GITHUB_OUTPUT
          echo "followers=$FOLLOWERS" >> $GITHUB_OUTPUT
          echo "commits=$COMMITS" >> $GITHUB_OUTPUT
          echo "prs=$PRS" >> $GITHUB_OUTPUT
          echo "issues=$ISSUES" >> $GITHUB_OUTPUT
          echo "lang=$LANG" >> $GITHUB_OUTPUT
          echo "total_xp=$TOTAL_XP" >> $GITHUB_OUTPUT
          echo "level=$LEVEL" >> $GITHUB_OUTPUT
          echo "xp_percentage=$XP_PERCENTAGE" >> $GITHUB_OUTPUT
          echo "class=$CLASS" >> $GITHUB_OUTPUT
          echo "rank=$RANK" >> $GITHUB_OUTPUT
          echo "avatar_url=$AVATAR_URL" >> $GITHUB_OUTPUT

      - name: üé® Gerar SVG Ultra Dark Neon (com avatar embutido)
        run: |
          mkdir -p cards
          USER="${{ github.event.inputs.usuario }}"
          NAME="${{ steps.fetch-data.outputs.name }}"
          LOGIN="${{ steps.fetch-data.outputs.login }}"
          BIO="${{ steps.fetch-data.outputs.bio }}"
          REPOS="${{ steps.fetch-data.outputs.repos }}"
          FOLLOWERS="${{ steps.fetch-data.outputs.followers }}"
          LANG="${{ steps.fetch-data.outputs.lang }}"
          LEVEL="${{ steps.fetch-data.outputs.level }}"
          TOTAL_XP="${{ steps.fetch-data.outputs.total_xp }}"
          XP_PERCENTAGE="${{ steps.fetch-data.outputs.xp_percentage }}"
          CLASS="${{ steps.fetch-data.outputs.class }}"
          RANK="${{ steps.fetch-data.outputs.rank }}"
          COMMITS="${{ steps.fetch-data.outputs.commits }}"
          PRS="${{ steps.fetch-data.outputs.prs }}"
          ISSUES="${{ steps.fetch-data.outputs.issues }}"
          AVATAR_URL="${{ steps.fetch-data.outputs.avatar_url }}"
          EMPRESA="${{ github.event.inputs.empresa }}"
          CARGO="${{ github.event.inputs.cargo }}"

          # Top projects
          PROJECT1_NAME=$(jq -r '.[0].name // ""' top_projects.json)
          PROJECT1_STARS=$(jq -r '.[0].stars // 0' top_projects.json)
          PROJECT2_NAME=$(jq -r '.[1].name // ""' top_projects.json)
          PROJECT2_STARS=$(jq -r '.[1].stars // 0' top_projects.json)

          CURRENT_DATE=$(date +'%d/%m/%Y')

          # Baixar avatar e converter para base64 (se existir)
          AVATAR_B64=""
          if [ -n "$AVATAR_URL" ] && [ "$AVATAR_URL" != "null" ]; then
            curl -s -L "$AVATAR_URL" -o avatar.png || true
            if [ -f avatar.png ]; then
              AVATAR_B64=$(base64 -w0 avatar.png)
              rm -f avatar.png
            fi
          fi

          # Calcular largura da barra de XP (max 320)
          BAR_MAX=320
          BAR_WIDTH=$(( BAR_MAX * XP_PERCENTAGE / 100 ))

          # Gerar SVG com estilo vibrante dark + neon, avatar circular, glow e barra de XP animada (est√°tica no SVG)
          cat > cards/${USER}.svg <<EOF
<svg xmlns="http://www.w3.org/2000/svg" width="920" height="360" viewBox="0 0 920 360">
  <defs>
    <linearGradient id="bg" x1="0" x2="1" y1="0" y2="1">
      <stop offset="0%" stop-color="#0b0b0f"/>
      <stop offset="50%" stop-color="#12000a"/>
      <stop offset="100%" stop-color="#1b0014"/>
    </linearGradient>

    <radialGradient id="neon" cx="50%" cy="20%" r="60%">
      <stop offset="0%" stop-color="#ff3b6b" stop-opacity="0.95"/>
      <stop offset="50%" stop-color="#ff7a00" stop-opacity="0.6"/>
      <stop offset="100%" stop-color="#7a00ff" stop-opacity="0.15"/>
    </radialGradient>

    <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
      <feGaussianBlur stdDeviation="6" result="coloredBlur"/>
      <feMerge>
        <feMergeNode in="coloredBlur"/>
        <feMergeNode in="SourceGraphic"/>
      </feMerge>
    </filter>

    <style>
      .card { font-family: Inter, Roboto, system-ui, -apple-system, "Segoe UI", "Helvetica Neue", Arial; }
      .title { font-size: 28px; font-weight: 800; fill: #ffd7e0; letter-spacing: 0.5px; }
      .handle { font-size: 14px; fill: #ffb3c7; opacity: 0.95; }
      .meta { font-size: 13px; fill: #ff9fb8; opacity: 0.9; }
      .bio { font-size: 12px; fill: #f7cbd6; opacity: 0.9; }
      .small { font-size: 11px; fill: #ffbfcf; opacity: 0.85; }
      .badge { font-size: 12px; font-weight: 700; fill: #12000a; }
      .xp-num { font-size: 13px; fill: #fff; font-weight: 700; }
      .proj { font-size: 13px; fill: #ffdfe6; }
      .footer { font-size: 11px; fill: #ffbfcf; opacity: 0.8; }
      .bar-bg { fill: rgba(255,255,255,0.04); stroke: rgba(255,255,255,0.06); rx: 8; ry: 8; }
      .bar-fill { fill: url(#neon); filter: url(#glow); rx: 8; ry: 8; }
      .avatar-ring { fill: none; stroke: #ff3b6b; stroke-width: 4; filter: url(#glow); }
    </style>
  </defs>

  <rect width="920" height="360" rx="20" ry="20" fill="url(#bg)" stroke="#2a0018" stroke-width="4"/>

  <!-- Left panel: avatar + basic -->
  <g transform="translate(28,28)">
    <rect x="0" y="0" width="360" height="304" rx="14" ry="14" fill="rgba(255,255,255,0.02)" stroke="rgba(255,255,255,0.03)"/>
    <!-- Avatar circle -->
    <g transform="translate(24,20)">
      <circle cx="64" cy="64" r="66" fill="#0b0b0f" />
EOF

# continue SVG with avatar conditional insertion
          if [ -n "$AVATAR_B64" ]; then
            cat >> cards/${USER}.svg <<EOF
      <clipPath id="avatarClip">
        <circle cx="64" cy="64" r="60"/>
      </clipPath>
      <image x="4" y="4" width="120" height="120" clip-path="url(#avatarClip)" href="data:image/png;base64,${AVATAR_B64}" preserveAspectRatio="xMidYMid slice"/>
      <circle cx="64" cy="64" r="66" class="avatar-ring"/>
EOF
          else
            # fallback: initials
            INITIALS=$(echo "$NAME" | awk '{for(i=1;i<=NF;i++){printf toupper(substr($i,1,1))}}' | cut -c1-2)
            cat >> cards/${USER}.svg <<EOF
      <circle cx="64" cy="64" r="60" fill="#1b0014"/>
      <text x="64" y="78" text-anchor="middle" class="title" style="font-size:36px;fill:#ffb3c7">${INITIALS}</text>
      <circle cx="64" cy="64" r="66" class="avatar-ring"/>
EOF
          fi

# continue rest of SVG
          cat >> cards/${USER}.svg <<EOF
    </g>

    <!-- Name and handle -->
    <g transform="translate(160,28)">
      <text x="0" y="28" class="title">${NAME}</text>
      <text x="0" y="52" class="handle">@${LOGIN}</text>
      <text x="0" y="74" class="meta">üè¢ ${EMPRESA} ‚Ä¢ üíº ${CARGO}</text>
      <text x="0" y="96" class="meta">‚öîÔ∏è ${CLASS} ‚Ä¢ ü©∏ ${RANK}</text>
      <text x="0" y="118" class="bio">${BIO}</text>
    </g>

    <!-- XP block -->
    <g transform="translate(24,160)">
      <text x="0" y="18" class="small">üèÜ N√≠vel <tspan class="xp-num">${LEVEL}</tspan> ‚Ä¢ XP Total <tspan class="xp-num">${TOTAL_XP}</tspan></text>
      <rect x="0" y="28" width="${BAR_MAX}" height="18" class="bar-bg"/>
      <rect x="0" y="28" width="${BAR_WIDTH}" height="18" class="bar-fill"/>
      <text x="${BAR_MAX}" y="42" text-anchor="end" class="small">${XP_PERCENTAGE}%</text>
    </g>

    <!-- Stats -->
    <g transform="translate(24,200)">
      <text x="0" y="18" class="small">üì¶ Repos: <tspan class="xp-num">${REPOS}</tspan> ‚Ä¢ üë• Followers: <tspan class="xp-num">${FOLLOWERS}</tspan></text>
      <text x="0" y="38" class="small">üîß Commits: <tspan class="xp-num">${COMMITS}</tspan> ‚Ä¢ PRs: <tspan class="xp-num">${PRS}</tspan> ‚Ä¢ Issues: <tspan class="xp-num">${ISSUES}</tspan></text>
    </g>
  </g>

  <!-- Right panel: projetos e destaques -->
  <g transform="translate(420,28)">
    <rect x="0" y="0" width="476" height="304" rx="14" ry="14" fill="rgba(255,255,255,0.01)" stroke="rgba(255,255,255,0.02)"/>
    <text x="24" y="40" class="title" style="font-size:20px;fill:#ffdfe6">‚≠ê Destaques & Projetos</text>

    <g transform="translate(24,64)">
      <text x="0" y="0" class="proj">‚Ä¢ ${PROJECT1_NAME} <tspan class="small">‚Äî ‚≠ê ${PROJECT1_STARS}</tspan></text>
      <text x="0" y="28" class="proj">‚Ä¢ ${PROJECT2_NAME} <tspan class="small">‚Äî ‚≠ê ${PROJECT2_STARS}</tspan></text>

      <rect x="0" y="56" width="420" height="1" fill="rgba(255,255,255,0.03)"/>

      <text x="0" y="86" class="proj">üíª Linguagem principal: <tspan class="small">${LANG}</tspan></text>
      <text x="0" y="110" class="proj">üîó Perfil: <tspan class="small">https://github.com/${LOGIN}</tspan></text>

      <g transform="translate(0,140)">
        <text x="0" y="0" class="proj" style="font-weight:800;fill:#ffdfef">Badges</text>
        <g transform="translate(0,18)">
          <rect x="0" y="0" width="120" height="28" rx="8" ry="8" fill="#ff3b6b" />
          <text x="60" y="18" text-anchor="middle" class="badge">Top Contributor</text>

          <rect x="140" y="0" width="120" height="28" rx="8" ry="8" fill="#ff7a00" />
          <text x="200" y="18" text-anchor="middle" class="badge">Open Source</text>

          <rect x="280" y="0" width="120" height="28" rx="8" ry="8" fill="#7a00ff" />
          <text x="340" y="18" text-anchor="middle" class="badge">Community</text>
        </g>
      </g>
    </g>

    <text x="238" y="282" text-anchor="middle" class="footer">Gerado em ${CURRENT_DATE} ‚Ä¢ commits ${COMMITS} ‚Ä¢ PRs ${PRS} ‚Ä¢ issues ${ISSUES}</text>
  </g>
</svg>
EOF

          echo "‚úÖ SVG Ultra Dark Neon gerado: cards/${USER}.svg"

      - name: üíæ Commit e Push autom√°tico
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add cards/
          git commit -m "‚ú® Ultra Card atualizado para ${{ github.event.inputs.usuario }}" || echo "Nenhuma mudan√ßa detectada"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
