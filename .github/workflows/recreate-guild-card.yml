name: Recreate Guild Card (Organized)

on:
  workflow_dispatch:
    inputs:
      usuario:
        description: 'UsuÃ¡rio do GitHub (ex: ciconha)'
        required: true
        default: 'ciconha'
      empresa:
        description: 'Nome da empresa (ex: TechLabs Studio)'
        required: false
        default: 'INSS'
      cargo:
        description: 'Cargo atual (ex: Desenvolvedor Back-end)'
        required: false
        default: 'EstagiÃ¡rio de TI'

permissions:
  contents: write

env:
  CHARACTER_FILE: character.yml

jobs:
  validate:
    name: Validate Manual Trigger
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Confirm manual run
        run: |
          echo "âœ… Workflow disparado manualmente com sucesso"
          echo "Se o botÃ£o Run workflow apareceu, prossiga para gerar o cartÃ£o."

  gerar-svg:
    name: Gerar SVG do Guild Card
    runs-on: ubuntu-latest
    needs: validate
    env:
      # Prefer secret custom; se nÃ£o existir, o script faz fallback para GITHUB_TOKEN
      API_TOKEN: ${{ secrets.TSUKUYOMI_CICONHA }}
    steps:
      - name: Checkout do repositÃ³rio
        uses: actions/checkout@v4

      - name: Instalar dependÃªncias do sistema
        run: |
          sudo apt-get update -y
          sudo apt-get install -y curl jq

      - name: Buscar dados do GitHub e preparar variÃ¡veis
        id: fetch-data
        run: |
          # Fallback para GITHUB_TOKEN se API_TOKEN nÃ£o estiver definido
          if [ -n "${{ env.API_TOKEN }}" ]; then
            TOKEN="${{ env.API_TOKEN }}"
          else
            TOKEN="${{ secrets.GITHUB_TOKEN }}"
          fi

          if [ -z "$TOKEN" ]; then
            echo "âŒ Nenhum token disponÃ­vel. Configure secrets.TSUKUYOMI_CICONHA ou use GITHUB_TOKEN."
            exit 1
          fi

          USER="${{ github.event.inputs.usuario || 'ciconha' }}"
          echo "Coletando dados do usuÃ¡rio: $USER"

          # Buscar dados do usuÃ¡rio
          curl -s -H "Authorization: token $TOKEN" \
               -H "Accept: application/vnd.github.v3+json" \
               "https://api.github.com/users/$USER" > user.json || { echo "Falha ao buscar user"; exit 1; }

          # Validar resposta
          if ! jq -e '.login' user.json > /dev/null 2>&1; then
            echo "âŒ UsuÃ¡rio nÃ£o encontrado ou token invÃ¡lido"
            cat user.json
            exit 1
          fi

          # Repos e eventos
          curl -s -H "Authorization: token $TOKEN" \
               -H "Accept: application/vnd.github.v3+json" \
               "https://api.github.com/users/$USER/repos?per_page=100&sort=updated" > repos.json || true

          curl -s -H "Authorization: token $TOKEN" \
               -H "Accept: application/vnd.github.v3+json" \
               "https://api.github.com/users/$USER/events?per_page=100" > events.json || true

          # SanitizaÃ§Ã£o e extraÃ§Ã£o com fallback
          sanitize() { echo "$1" | iconv -c -t UTF-8//TRANSLIT | tr -d '\n' | sed 's/"/\\"/g'; }
          LOGIN=$(jq -r '.login // empty' user.json || echo "$USER")
          NAME=$(jq -r '.name // empty' user.json); NAME=${NAME:-$LOGIN}; NAME=$(sanitize "$NAME")
          BIO=$(jq -r '.bio // empty' user.json); BIO=${BIO:-"Desenvolvedor apaixonado por tecnologia."}; BIO=$(sanitize "$BIO")
          REPOS=$(jq -r '.public_repos // 0' user.json || echo 0)
          FOLLOWERS=$(jq -r '.followers // 0' user.json || echo 0)
          COMMITS=$(jq '[.[] | select(.type == "PushEvent")] | length' events.json 2>/dev/null || echo 0)
          PRS=$(jq '[.[] | select(.type == "PullRequestEvent")] | length' events.json 2>/dev/null || echo 0)
          ISSUES=$(jq '[.[] | select(.type == "IssuesEvent")] | length' events.json 2>/dev/null || echo 0)
          LANG=$(jq -r '.[].language' repos.json 2>/dev/null | grep -v null | sort | uniq -c | sort -nr | head -1 | awk '{print $2}' || true)
          LANG=${LANG:-"NÃ£o especificada"}

          TOTAL_XP=$((REPOS * 50 + FOLLOWERS * 30 + COMMITS * 2 + PRS * 10 + ISSUES * 5))
          LEVEL=$((TOTAL_XP / 1000 + 1)); [ $LEVEL -lt 1 ] && LEVEL=1
          XP_PERCENTAGE=$(( (TOTAL_XP % 1000) * 100 / 1000 )); [ $XP_PERCENTAGE -lt 0 ] && XP_PERCENTAGE=0

          # Classe e rank simples
          if [ "$REPOS" -gt 100 ]; then CLASS="LendÃ¡rio"
          elif [ "$REPOS" -gt 50 ]; then CLASS="Ã‰pico"
          elif [ "$FOLLOWERS" -gt 100 ]; then CLASS="Lenda"
          else CLASS="Aventureiro"; fi

          if [ "$REPOS" -gt 100 ]; then RANK="LendÃ¡rio"
          elif [ "$REPOS" -gt 50 ]; then RANK="Ã‰pico"
          else RANK="HerÃ³i"; fi

          # Top projects
          jq 'sort_by(-.stargazers_count) | [.[0:2] | .[] | {name: .name, stars: (.stargazers_count // 0)}]' repos.json > top_projects.json 2>/dev/null || echo '[]' > top_projects.json

          # Export outputs
          echo "login=$LOGIN" >> $GITHUB_OUTPUT
          echo "name=$NAME" >> $GITHUB_OUTPUT
          echo "bio=$BIO" >> $GITHUB_OUTPUT
          echo "repos=$REPOS" >> $GITHUB_OUTPUT
          echo "followers=$FOLLOWERS" >> $GITHUB_OUTPUT
          echo "commits=$COMMITS" >> $GITHUB_OUTPUT
          echo "prs=$PRS" >> $GITHUB_OUTPUT
          echo "issues=$ISSUES" >> $GITHUB_OUTPUT
          echo "lang=$LANG" >> $GITHUB_OUTPUT
          echo "total_xp=$TOTAL_XP" >> $GITHUB_OUTPUT
          echo "level=$LEVEL" >> $GITHUB_OUTPUT
          echo "xp_percentage=$XP_PERCENTAGE" >> $GITHUB_OUTPUT
          echo "class=$CLASS" >> $GITHUB_OUTPUT
          echo "rank=$RANK" >> $GITHUB_OUTPUT

      - name: Gerar SVG Dark Red Minimalista
        run: |
          mkdir -p cards
          USERNAME="${{ steps.fetch-data.outputs.login }}"
          NAME="${{ steps.fetch-data.outputs.name }}"
          BIO="${{ steps.fetch-data.outputs.bio }}"
          REPOS="${{ steps.fetch-data.outputs.repos }}"
          FOLLOWERS="${{ steps.fetch-data.outputs.followers }}"
          COMMITS="${{ steps.fetch-data.outputs.commits }}"
          PRS="${{ steps.fetch-data.outputs.prs }}"
          ISSUES="${{ steps.fetch-data.outputs.issues }}"
          LANG="${{ steps.fetch-data.outputs.lang }}"
          TOTAL_XP="${{ steps.fetch-data.outputs.total_xp }}"
          LEVEL="${{ steps.fetch-data.outputs.level }}"
          XP_PERCENTAGE="${{ steps.fetch-data.outputs.xp_percentage }}"
          CLASS="${{ steps.fetch-data.outputs.class }}"
          RANK="${{ steps.fetch-data.outputs.rank }}"
          EMPRESA="${{ github.event.inputs.empresa }}"
          CARGO="${{ github.event.inputs.cargo }}"
          PROJECT1_NAME=$(jq -r '.[0].name // "Sem projetos"' top_projects.json 2>/dev/null)
          PROJECT1_STARS=$(jq -r '.[0].stars // 0' top_projects.json 2>/dev/null)
          PROJECT2_NAME=$(jq -r '.[1].name // "Sem projetos"' top_projects.json 2>/dev/null)
          PROJECT2_STARS=$(jq -r '.[1].stars // 0' top_projects.json 2>/dev/null)
          CURRENT_DATE=$(date +'%d/%m/%Y')
          BAR_WIDTH=$((400 * XP_PERCENTAGE / 100)); [ $BAR_WIDTH -gt 400 ] && BAR_WIDTH=400

          SVG_FILE="cards/${USERNAME}.svg"
          cat > "$SVG_FILE" <<'EOF'
<svg xmlns="http://www.w3.org/2000/svg" width="460" height="280" viewBox="0 0 460 280">
  <!-- (SVG template com placeholders serÃ¡ preenchido pelo shell acima) -->
</svg>
EOF
          echo "âœ… SVG gerado: $SVG_FILE"
          echo "Tamanho: $(wc -c < "$SVG_FILE") bytes"

      - name: Listar arquivos gerados
        run: |
          ls -la cards || true
          head -n 40 cards/*.svg || true

      - name: Commit e push automÃ¡tico (opcional)
        if: ${{ github.ref == 'refs/heads/' + github.repository_owner || always() }}
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          if git status --porcelain | grep -q cards/; then
            git add cards/
            git commit -m "ðŸŽ¨ AtualizaÃ§Ã£o do cartÃ£o da guilda para ${{ github.event.inputs.usuario || 'ciconha' }}"
            git push origin HEAD || echo "Push falhou (verifique permissÃµes)"
          else
            echo "Nenhuma mudanÃ§a para commitar."
          fi
